<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JLPT N1 ë…í•´ ë¬¸ì œ ìƒì„±ê¸°</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .fade-in {
        animation: fadeIn 0.5s ease-out;
      }
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .choice-button {
        transition: all 0.2s;
      }
      .choice-button:hover:not(:disabled) {
        transform: translateX(4px);
      }
      .choice-button.selected-correct {
        background-color: #dcfce7;
        border-color: #16a34a;
      }
      .choice-button.selected-wrong {
        background-color: #fee2e2;
        border-color: #dc2626;
      }
      .metadata-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- generate-reading.js ë¡œì§ì„ ì§ì ‘ í¬í•¨ -->
    <script>
      // ==========================================
      // ë¬¸ì œ ìƒì„± í•¨ìˆ˜ (generate-reading.js ë‚´ìš©)
      // ==========================================

      async function generateReadingProblem() {
        const startTime = Date.now();
        const metadata = {
          generatedAt: new Date().toISOString(),
          generationTimeMs: 0,
          parameters: {},
          source: "ai",
          version: "2.0.0",
        };

        try {
          console.log("=== JLPT N1 ë…í•´ ë¬¸ì œ ìƒì„± ì‹œì‘ ===");

          // 1. topics.json ë¡œë“œ
          const topicsResponse = await fetch("data/topics.json");
          if (!topicsResponse.ok) throw new Error("topics.json ë¡œë“œ ì‹¤íŒ¨");
          const topicsData = await topicsResponse.json();

          const topicCategories = Object.keys(topicsData.topics);
          const randomTopicCategory =
            topicCategories[Math.floor(Math.random() * topicCategories.length)];
          const topicItems = topicsData.topics[randomTopicCategory].items;
          const selectedTopic =
            topicItems[Math.floor(Math.random() * topicItems.length)];

          metadata.parameters.topic = {
            category: randomTopicCategory,
            categoryLabel: topicsData.topics[randomTopicCategory].category,
            topic: selectedTopic,
          };

          console.log("âœ… ì£¼ì œ ì„ íƒ:", selectedTopic);

          // 2. genre.json ë¡œë“œ
          const genreResponse = await fetch("data/genre.json");
          if (!genreResponse.ok) throw new Error("genre.json ë¡œë“œ ì‹¤íŒ¨");
          const genreData = await genreResponse.json();

          const trapElements = genreData.find(
            (g) => g.type === "n1_trap_elements"
          );
          const genres = genreData.filter((g) => g.type !== "n1_trap_elements");
          const selectedGenre =
            genres[Math.floor(Math.random() * genres.length)];

          metadata.parameters.genre = {
            type: selectedGenre.type,
            label: selectedGenre.label,
            description: selectedGenre.description,
          };

          console.log("âœ… ì¥ë¥´ ì„ íƒ:", selectedGenre.label);

          // 3. length-definitions.json ë¡œë“œ
          const lengthResponse = await fetch("data/length-definitions.json");
          if (!lengthResponse.ok)
            throw new Error("length-definitions.json ë¡œë“œ ì‹¤íŒ¨");
          const lengthData = await lengthResponse.json();

          const lengthTypes = Object.keys(lengthData.length_categories);
          const randomLengthType =
            lengthTypes[Math.floor(Math.random() * lengthTypes.length)];
          const selectedLength = lengthData.length_categories[randomLengthType];

          const subtypes = Object.keys(selectedLength.subtypes);
          const randomSubtype =
            subtypes[Math.floor(Math.random() * subtypes.length)];
          const selectedSubtype = selectedLength.subtypes[randomSubtype];

          metadata.parameters.length = {
            type: randomLengthType,
            label: selectedLength.base_info.label,
            characterRange: selectedSubtype.character_range,
            subtypeLabel: selectedSubtype.label,
          };

          console.log("âœ… ê¸¸ì´ ì„ íƒ:", selectedSubtype.label);

          // 4. Claude API í˜¸ì¶œ
          const prompt = `ë‹¹ì‹ ì€ JLPT N1 ìˆ˜ì¤€ì˜ ì¼ë³¸ì–´ ë…í•´ ë¬¸ì œë¥¼ ì¶œì œí•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ë‹¤ìŒ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ë…í•´ ë¬¸ì œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”:

1. ì£¼ì œ: "${selectedTopic}"
2. ì¥ë¥´: ${selectedGenre.label}
3. ì§€ë¬¸ ê¸¸ì´: ${selectedSubtype.character_range}

JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "passage": "ë…í•´ ì§€ë¬¸ (ì¼ë³¸ì–´)",
  "question": "ì´ ê¸€ì˜ ì£¼ì¥ìœ¼ë¡œ ê°€ì¥ ì ì ˆí•œ ê²ƒì€?",
  "options": ["ì„ íƒì§€1", "ì„ íƒì§€2", "ì„ íƒì§€3", "ì„ íƒì§€4"],
  "correctAnswer": 0,
  "explanation": "ì •ë‹µ í•´ì„¤ (í•œêµ­ì–´)",
  "grammarPoints": ["ë¬¸ë²•1", "ë¬¸ë²•2", "ë¬¸ë²•3"],
  "vocabularyLevel": "N1"
}`;

          console.log("ğŸ¤– Claude API í˜¸ì¶œ ì¤‘...");

          const apiStartTime = Date.now();
          const response = await fetch(
            "https://api.anthropic.com/v1/messages",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                model: "claude-sonnet-4-20250514",
                max_tokens: 4000,
                messages: [{ role: "user", content: prompt }],
              }),
            }
          );

          metadata.apiCallTimeMs = Date.now() - apiStartTime;

          if (!response.ok) {
            throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
          }

          const data = await response.json();
          let responseText = data.content[0].text.trim();
          responseText = responseText
            .replace(/```json\s*/g, "")
            .replace(/```\s*/g, "")
            .trim();

          const problemData = JSON.parse(responseText);

          console.log("âœ… ë¬¸ì œ ìƒì„± ì™„ë£Œ");

          metadata.generationTimeMs = Date.now() - startTime;
          metadata.source = "ai";

          return {
            ...problemData,
            metadata: metadata,
          };
        } catch (error) {
          console.error("âŒ ë¬¸ì œ ìƒì„± ì˜¤ë¥˜:", error);

          // ë°±ì—… ë¬¸ì œ ë°˜í™˜
          metadata.generationTimeMs = Date.now() - startTime;
          metadata.source = "fallback";
          metadata.error = { message: error.message };

          return {
            passage:
              "ç¾ä»£ç¤¾ä¼šã«ãŠã„ã¦ã€æŠ€è¡“é©æ–°ã¯ç›®è¦šã¾ã—ã„ç™ºå±•ã‚’é‚ã’ã¦ã„ã‚‹ã€‚ã—ã‹ã—ãªãŒã‚‰ã€æŠ€è¡“ã®é€²æ­©ãŒå¿…ãšã—ã‚‚äººé–“ã®å¹¸ç¦ã«ç›´çµã™ã‚‹ã¨ã¯é™ã‚‰ãªã„ã€‚ã‚€ã—ã‚ã€æŠ€è¡“ã«ä¾å­˜ã—ã™ãã‚‹ã“ã¨ã§ã€äººé–“æœ¬æ¥ã®èƒ½åŠ›ã‚„æ„Ÿæ€§ãŒè¡°é€€ã™ã‚‹å±é™ºæ€§ã‚‚æŒ‡æ‘˜ã•ã‚Œã¦ã„ã‚‹ã€‚ã—ãŸãŒã£ã¦ã€æŠ€è¡“ã¨äººé–“æ€§ã®ãƒãƒ©ãƒ³ã‚¹ã‚’ä¿ã¤ã“ã¨ãŒã€ä»Šå¾Œã®èª²é¡Œã¨ã—ã¦æŒ™ã’ã‚‰ã‚Œã‚‹ã€‚",
            question: "ã“ã®æ–‡ç« ã®ä¸»å¼µã¨ã—ã¦æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã¯?",
            options: [
              "æŠ€è¡“é©æ–°ã¯äººé–“ã®å¹¸ç¦ã«å¿…ãšè²¢çŒ®ã™ã‚‹",
              "æŠ€è¡“ã®é€²æ­©ã¨äººé–“æ€§ã®ãƒãƒ©ãƒ³ã‚¹ãŒé‡è¦ã§ã‚ã‚‹",
              "æŠ€è¡“ã«ä¾å­˜ã™ã‚‹ã“ã¨ã¯å®Œå…¨ã«é¿ã‘ã‚‹ã¹ãã ",
              "ç¾ä»£ç¤¾ä¼šã§ã¯æŠ€è¡“é©æ–°ãŒä¸è¦ã§ã‚ã‚‹",
            ],
            correctAnswer: 1,
            explanation:
              "æ–‡ç« ã§ã¯ã€ŒæŠ€è¡“ã¨äººé–“æ€§ã®ãƒãƒ©ãƒ³ã‚¹ã‚’ä¿ã¤ã“ã¨ãŒèª²é¡Œã€ã¨è¿°ã¹ã¦ãŠã‚Šã€é¸æŠè‚¢2ãŒæœ€ã‚‚é©åˆ‡ã§ã™ã€‚",
            grammarPoints: [
              "ã€œã«ãŠã„ã¦",
              "ã€œã¨ã¯é™ã‚‰ãªã„",
              "ã€œã¨ã—ã¦æŒ™ã’ã‚‰ã‚Œã‚‹",
            ],
            vocabularyLevel: "N1",
            metadata: metadata,
          };
        }
      }

      // window ê°ì²´ì— ë“±ë¡
      window.generateReadingProblem = generateReadingProblem;
      console.log("âœ… generateReadingProblem í•¨ìˆ˜ ë“±ë¡ ì™„ë£Œ");
    </script>

    <!-- React ì•± -->
    <script type="text/babel">
      const { useState, useEffect } = React;

      function App() {
        const [isGenerating, setIsGenerating] = useState(false);
        const [currentProblem, setCurrentProblem] = useState(null);
        const [metadata, setMetadata] = useState(null);
        const [selectedAnswer, setSelectedAnswer] = useState(null);
        const [showExplanation, setShowExplanation] = useState(false);
        const [score, setScore] = useState({ correct: 0, total: 0 });
        const [streak, setStreak] = useState(0);
        const [problemHistory, setProblemHistory] = useState([]);
        const [apiError, setApiError] = useState(null);
        const [showMetadata, setShowMetadata] = useState(false);

        useEffect(() => {
          const savedScore = localStorage.getItem("jlpt-reading-score");
          const savedStreak = localStorage.getItem("jlpt-reading-streak");
          const savedHistory = localStorage.getItem("jlpt-reading-history");

          if (savedScore) setScore(JSON.parse(savedScore));
          if (savedStreak) setStreak(parseInt(savedStreak));
          if (savedHistory) setProblemHistory(JSON.parse(savedHistory));
        }, []);

        const saveData = (newScore, newStreak, newHistory) => {
          localStorage.setItem("jlpt-reading-score", JSON.stringify(newScore));
          localStorage.setItem("jlpt-reading-streak", newStreak.toString());
          localStorage.setItem(
            "jlpt-reading-history",
            JSON.stringify(newHistory)
          );
        };

        const generateProblem = async () => {
          setIsGenerating(true);
          setApiError(null);
          setCurrentProblem(null);
          setMetadata(null);
          setSelectedAnswer(null);
          setShowExplanation(false);

          try {
            const result = await window.generateReadingProblem();
            setCurrentProblem(result);
            setMetadata(result.metadata);
            console.log("âœ… ë¬¸ì œ ìƒì„± ì„±ê³µ:", result);
          } catch (error) {
            console.error("âŒ ì˜¤ë¥˜:", error);
            setApiError(error.message);
          } finally {
            setIsGenerating(false);
          }
        };

        const handleSubmit = (answerIndex) => {
          if (selectedAnswer !== null || !currentProblem) return;

          setSelectedAnswer(answerIndex);
          setShowExplanation(true);

          const isCorrect = answerIndex === currentProblem.correctAnswer;
          const newScore = {
            correct: score.correct + (isCorrect ? 1 : 0),
            total: score.total + 1,
          };
          const newStreak = isCorrect ? streak + 1 : 0;

          const historyEntry = {
            timestamp: new Date().toISOString(),
            correct: isCorrect,
            problem: currentProblem.question,
            metadata: metadata,
          };
          const newHistory = [historyEntry, ...problemHistory].slice(0, 50);

          setScore(newScore);
          setStreak(newStreak);
          setProblemHistory(newHistory);
          saveData(newScore, newStreak, newHistory);
        };

        const handleNext = () => {
          setCurrentProblem(null);
          setMetadata(null);
          setSelectedAnswer(null);
          setShowExplanation(false);
          generateProblem();
        };

        const accuracy =
          score.total > 0 ? Math.round((score.correct / score.total) * 100) : 0;

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8 px-4">
            <div className="max-w-4xl mx-auto">
              <div className="text-center mb-8">
                <h1 className="text-4xl font-bold text-indigo-900 mb-2">
                  ğŸ“– JLPT N1 ë…í•´ ë¬¸ì œ ìƒì„±ê¸°
                </h1>
                <p className="text-gray-600">
                  AIê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ë§ì¶¤í˜• ë…í•´ ë¬¸ì œ
                </p>
                <div className="mt-4 flex justify-center gap-4 text-sm flex-wrap">
                  <a
                    href="kanji-generator.html"
                    className="bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600"
                  >
                    ğŸ“¤ í•œì ë¬¸ì œ
                  </a>
                  <a
                    href="grammar-generator.html"
                    className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
                  >
                    ğŸ“š ë¬¸ë²• ë¬¸ì œ
                  </a>
                  <a
                    href="vocabulary-generator.html"
                    className="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600"
                  >
                    ğŸ’­ ì–´íœ˜ ë¬¸ì œ
                  </a>
                  <a
                    href="mixed-generator.html"
                    className="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600"
                  >
                    ğŸ¯ í†µí•© ë¬¸ì œ
                  </a>
                  <a
                    href="stats.html"
                    className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                  >
                    ğŸ“Š í•™ìŠµ í†µê³„
                  </a>
                </div>
              </div>

              <div className="grid md:grid-cols-4 gap-4 mb-6">
                <div className="bg-blue-50 p-4 rounded-lg text-center">
                  <div className="text-lg font-semibold text-blue-800">
                    ì •ë‹µë¥ : {accuracy}%
                  </div>
                  <div className="text-sm text-gray-600">
                    {score.correct} / {score.total}
                  </div>
                </div>
                <div className="bg-green-50 p-4 rounded-lg text-center">
                  <div className="text-lg font-semibold text-green-800">
                    ì—°ì† ì •ë‹µ: {streak}
                  </div>
                  <div className="text-sm text-gray-600">ìµœê³  ê¸°ë¡ ë‹¬ì„±ì¤‘</div>
                </div>
                <div className="bg-purple-50 p-4 rounded-lg text-center">
                  <div className="text-lg font-semibold text-purple-800">
                    ì´ ë¬¸ì œ: {score.total}
                  </div>
                  <div className="text-sm text-gray-600">í•™ìŠµ ì§„í–‰ì¤‘</div>
                </div>
                <div className="bg-orange-50 p-4 rounded-lg text-center">
                  <div className="text-lg font-semibold text-orange-800">
                    {metadata?.source === "ai" ? "ğŸ¤– AI ìƒì„±" : "ğŸ“š ë°±ì—…"}
                  </div>
                  <div className="text-sm text-gray-600">ë¬¸ì œ ì¶œì²˜</div>
                </div>
              </div>

              {!currentProblem && (
                <div className="text-center mb-8">
                  <button
                    onClick={generateProblem}
                    disabled={isGenerating}
                    className="bg-indigo-600 text-white px-8 py-4 rounded-lg font-semibold text-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                  >
                    {isGenerating ? (
                      <>
                        <div className="loading-spinner mr-2"></div>
                        ë¬¸ì œ ìƒì„± ì¤‘...
                      </>
                    ) : (
                      "ğŸ² ìƒˆë¡œìš´ ë¬¸ì œ ìƒì„±í•˜ê¸°"
                    )}
                  </button>

                  {apiError && (
                    <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg max-w-md mx-auto">
                      <p className="text-red-700 text-sm">
                        âš ï¸ API ì˜¤ë¥˜: {apiError}
                      </p>
                      <p className="text-red-600 text-xs mt-2">
                        ë°±ì—… ë¬¸ì œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                      </p>
                    </div>
                  )}
                </div>
              )}

              {currentProblem && (
                <div className="fade-in">
                  <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h2 className="text-xl font-semibold text-gray-800 mb-4">
                      ğŸ“„ ì§€ë¬¸
                    </h2>
                    <div className="text-gray-700 leading-relaxed text-lg border-l-4 border-indigo-500 pl-4">
                      {currentProblem.passage}
                    </div>
                  </div>

                  <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4">
                      â“ {currentProblem.question}
                    </h3>

                    <div className="space-y-3">
                      {currentProblem.options.map((option, index) => {
                        const isSelected = selectedAnswer === index;
                        const isCorrect =
                          index === currentProblem.correctAnswer;
                        const showResult = showExplanation;

                        let buttonClass =
                          "choice-button w-full text-left p-4 rounded-lg border-2 transition-all ";

                        if (!showResult) {
                          buttonClass +=
                            "border-gray-300 hover:border-indigo-500 hover:bg-indigo-50";
                        } else if (isCorrect) {
                          buttonClass += "selected-correct border-green-500";
                        } else if (isSelected && !isCorrect) {
                          buttonClass += "selected-wrong border-red-500";
                        } else {
                          buttonClass += "border-gray-300 opacity-50";
                        }

                        return (
                          <button
                            key={index}
                            onClick={() => handleSubmit(index)}
                            disabled={showExplanation}
                            className={buttonClass}
                          >
                            <div className="flex items-center">
                              <span className="font-semibold mr-3 text-gray-600">
                                {index + 1}.
                              </span>
                              <span className="flex-1">{option}</span>
                              {showResult && isCorrect && (
                                <span className="ml-2 text-green-600 font-bold">
                                  âœ“ ì •ë‹µ
                                </span>
                              )}
                              {showResult && isSelected && !isCorrect && (
                                <span className="ml-2 text-red-600 font-bold">
                                  âœ—
                                </span>
                              )}
                            </div>
                          </button>
                        );
                      })}
                    </div>
                  </div>

                  {showExplanation && (
                    <div className="bg-white p-6 rounded-lg shadow-md mb-6 fade-in">
                      <h3 className="text-lg font-semibold text-gray-800 mb-3">
                        ğŸ’¡ í•´ì„¤
                      </h3>
                      <p className="text-gray-700 mb-4">
                        {currentProblem.explanation}
                      </p>

                      {currentProblem.grammarPoints &&
                        currentProblem.grammarPoints.length > 0 && (
                          <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                            <h4 className="font-semibold text-blue-800 mb-2">
                              ğŸ“ ì£¼ìš” ë¬¸ë²• í¬ì¸íŠ¸
                            </h4>
                            <ul className="list-disc list-inside text-gray-700 space-y-1">
                              {currentProblem.grammarPoints.map(
                                (point, idx) => (
                                  <li key={idx}>{point}</li>
                                )
                              )}
                            </ul>
                          </div>
                        )}

                      <div className="mt-4 text-center">
                        <button
                          onClick={handleNext}
                          className="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors"
                        >
                          â¡ï¸ ë‹¤ìŒ ë¬¸ì œ
                        </button>
                      </div>
                    </div>
                  )}

                  {metadata && (
                    <div className="mt-6">
                      <button
                        onClick={() => setShowMetadata(!showMetadata)}
                        className="text-sm text-gray-500 hover:text-gray-700"
                      >
                        {showMetadata ? "â–¼" : "â–¶"} ë¬¸ì œ ì •ë³´ (ê°œë°œììš©)
                      </button>

                      {showMetadata && (
                        <div className="metadata-box mt-2 text-sm">
                          <div className="grid grid-cols-2 gap-2">
                            <div>
                              <strong>ìƒì„± ì‹œê°:</strong>{" "}
                              {new Date(metadata.generatedAt).toLocaleString(
                                "ko-KR"
                              )}
                            </div>
                            <div>
                              <strong>ì†Œìš” ì‹œê°„:</strong>{" "}
                              {metadata.generationTimeMs}ms
                            </div>
                            {metadata.parameters?.topic && (
                              <div>
                                <strong>ì£¼ì œ:</strong>{" "}
                                {metadata.parameters.topic.topic}
                              </div>
                            )}
                            {metadata.parameters?.genre && (
                              <div>
                                <strong>ì¥ë¥´:</strong>{" "}
                                {metadata.parameters.genre.label}
                              </div>
                            )}
                            {metadata.parameters?.length && (
                              <div>
                                <strong>ê¸¸ì´:</strong>{" "}
                                {metadata.parameters.length.label}
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}

              <div className="text-center mt-8 text-sm text-gray-600">
                <p>ğŸ’¡ ë§¤ë²ˆ ìƒˆë¡œìš´ ë¬¸ì œë¡œ ì‹¤ë ¥ì„ í–¥ìƒì‹œí‚¤ì„¸ìš”!</p>
                <p className="mt-2">ë²„ì „ 2.0.1 | í†µí•© ë²„ì „</p>
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
