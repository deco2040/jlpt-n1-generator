<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JLPT N1 ë…í•´ ë¬¸ì œ ìƒì„±ê¸°</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .fade-in {
        animation: fadeIn 0.5s ease-out;
      }
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .choice-button {
        transition: all 0.2s;
      }
      .choice-button:hover:not(:disabled) {
        transform: translateX(4px);
      }
      .choice-button.selected-correct {
        background-color: #dcfce7;
        border-color: #16a34a;
      }
      .choice-button.selected-wrong {
        background-color: #fee2e2;
        border-color: #dc2626;
      }
      .metadata-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // â­ generateReadingProblem í•¨ìˆ˜ë¥¼ API í˜¸ì¶œ í•¨ìˆ˜ë¡œ ëŒ€ì²´
      const generateReadingProblemFromApi = async () => {
        const url = "/api/generate-reading"; // ì„œë²„ì˜ ë¬¸ì œ ìƒì„± API ì—”ë“œí¬ì¸íŠ¸

        try {
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(
              `HTTP ì˜¤ë¥˜: ${response.status} ${response.statusText}`
            );
          }

          const result = await response.json();
          return result;
        } catch (error) {
          console.error("API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          throw new Error(`ë¬¸ì œ ìƒì„± ì„œë²„ ì˜¤ë¥˜: ${error.message}`);
        }
      };

      function App() {
        // ìƒíƒœ ê´€ë¦¬
        const [isGenerating, setIsGenerating] = useState(false);
        const [currentProblem, setCurrentProblem] = useState(null);
        const [metadata, setMetadata] = useState(null);
        const [selectedAnswer, setSelectedAnswer] = useState(null);
        const [showExplanation, setShowExplanation] = useState(false);
        const [score, setScore] = useState({ correct: 0, total: 0 });
        const [streak, setStreak] = useState(0);
        const [problemHistory, setProblemHistory] = useState([]);
        const [apiError, setApiError] = useState(null);
        const [showMetadata, setShowMetadata] = useState(false);

        // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (API í˜¸ì¶œì´ë¯€ë¡œ ì œê±° ê°€ëŠ¥í•˜ë‚˜, êµ¬ì¡° ìœ ì§€ë¥¼ ìœ„í•´ ê°„ë‹¨í™”)
        useEffect(() => {
          console.log("ğŸ” API í˜¸ì¶œ ë°©ì‹ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.");
        }, []);

        // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¡œë“œ
        useEffect(() => {
          const savedScore = localStorage.getItem("jlpt-reading-score");
          const savedStreak = localStorage.getItem("jlpt-reading-streak");
          const savedHistory = localStorage.getItem("jlpt-reading-history");

          if (savedScore) setScore(JSON.parse(savedScore));
          if (savedStreak) setStreak(parseInt(savedStreak));
          if (savedHistory) setProblemHistory(JSON.parse(savedHistory));
        }, []);

        // ë°ì´í„° ì €ì¥
        const saveData = (newScore, newStreak, newHistory) => {
          localStorage.setItem("jlpt-reading-score", JSON.stringify(newScore));
          localStorage.setItem("jlpt-reading-streak", newStreak.toString());
          localStorage.setItem(
            "jlpt-reading-history",
            JSON.stringify(newHistory)
          );
        };

        // ë¬¸ì œ ìƒì„± í•¨ìˆ˜
        const generateProblem = async () => {
          setIsGenerating(true);
          setApiError(null);
          setCurrentProblem(null);
          setMetadata(null);
          setSelectedAnswer(null);
          setShowExplanation(false);

          try {
            // â­ API í˜¸ì¶œ í•¨ìˆ˜ ì‚¬ìš©
            const result = await generateReadingProblemFromApi();

            if (result.problem || result.passage) {
              // resultê°€ ì§ì ‘ ë¬¸ì œ ê°ì²´ì¼ ìˆ˜ë„ ìˆê³ , problemì„ í¬í•¨í•  ìˆ˜ë„ ìˆìŒ
              const problem = result.problem || result;
              setCurrentProblem(problem);
              setMetadata(
                result.metadata || {
                  source: "api_unknown", // APIì—ì„œ ë©”íƒ€ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í•œ ê²½ìš°
                  generatedAt: new Date().toISOString(),
                }
              );
              console.log("âœ… ë¬¸ì œ ìƒì„± ì„±ê³µ:", result);
            } else {
              throw new Error("ë¬¸ì œ ìƒì„± ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤");
            }
          } catch (error) {
            console.error("âŒ ë¬¸ì œ ìƒì„± ì˜¤ë¥˜:", error);
            setApiError(error.message);

            // ë°±ì—… ë¬¸ì œ ì‚¬ìš©
            setCurrentProblem({
              passage:
                "äººå·¥çŸ¥èƒ½ã®ç™ºå±•ã«ã‚ˆã‚Šã€ç§ãŸã¡ã®ç”Ÿæ´»ã¯å¤§ããå¤‰ã‚ã‚Šã¤ã¤ã‚ã‚‹ã€‚ã—ã‹ã—ã€æŠ€è¡“ã®é€²æ­©ãŒå¿…ãšã—ã‚‚äººé–“ã®å¹¸ç¦ã«ã¤ãªãŒã‚‹ã¨ã¯é™ã‚‰ãªã„ã€‚ã‚€ã—ã‚ã€æŠ€è¡“ã«ä¾å­˜ã—ã™ãã‚‹ã“ã¨ã§ã€äººé–“æœ¬æ¥ã®èƒ½åŠ›ãŒè¡°é€€ã™ã‚‹å±é™ºæ€§ã‚‚ã‚ã‚‹ã€‚é‡è¦ãªã®ã¯ã€æŠ€è¡“ã‚’é©åˆ‡ã«æ´»ç”¨ã—ãªãŒã‚‰ã€äººé–“ã‚‰ã—ã•ã‚’ä¿ã¤ãƒãƒ©ãƒ³ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã§ã‚ã‚‹ã€‚",
              question: "ã“ã®æ–‡ç« ã®ä¸»å¼µã¨ã—ã¦æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã¯ã©ã‚Œã‹ã€‚",
              options: [
                "äººå·¥çŸ¥èƒ½ã®ç™ºå±•ã¯äººé–“ã®å¹¸ç¦ã«ç›´çµã™ã‚‹",
                "æŠ€è¡“ã®é€²æ­©ã«ã‚ˆã‚Šäººé–“ã®èƒ½åŠ›ã¯å‘ä¸Šã™ã‚‹",
                "æŠ€è¡“ã¨äººé–“æ€§ã®ãƒãƒ©ãƒ³ã‚¹ãŒé‡è¦ã§ã‚ã‚‹",
                "æŠ€è¡“ã¸ã®ä¾å­˜ã‚’å®Œå…¨ã«é¿ã‘ã‚‹ã¹ãã§ã‚ã‚‹",
              ],
              correctAnswer: 2,
              explanation:
                "ç­†è€…ã¯æŠ€è¡“ã®é©åˆ‡ãªæ´»ç”¨ã¨äººé–“ã‚‰ã—ã•ã®ä¿æŒã®ãƒãƒ©ãƒ³ã‚¹ãŒé‡è¦ã ã¨ä¸»å¼µã—ã¦ã„ã¾ã™ã€‚",
              grammarPoints: ["ã€œã«ã¤ãªãŒã‚‹", "ã€œã¨ã¯é™ã‚‰ãªã„", "ã‚€ã—ã‚ã€œ"],
              vocabularyLevel: "N1",
            });
            setMetadata({
              source: "fallback",
              generatedAt: new Date().toISOString(),
              error: error.message,
            });
          } finally {
            setIsGenerating(false);
          }
        };

        // ë‹µì•ˆ ì œì¶œ
        const handleSubmit = (answerIndex) => {
          if (selectedAnswer !== null || !currentProblem) return;

          setSelectedAnswer(answerIndex);
          setShowExplanation(true);

          const isCorrect = answerIndex === currentProblem.correctAnswer;
          const newScore = {
            correct: score.correct + (isCorrect ? 1 : 0),
            total: score.total + 1,
          };
          const newStreak = isCorrect ? streak + 1 : 0;

          const historyEntry = {
            timestamp: new Date().toISOString(),
            correct: isCorrect,
            problem: currentProblem.question,
            metadata: metadata,
          };
          const newHistory = [historyEntry, ...problemHistory].slice(0, 50);

          setScore(newScore);
          setStreak(newStreak);
          setProblemHistory(newHistory);
          saveData(newScore, newStreak, newHistory);
        };

        // ë‹¤ìŒ ë¬¸ì œ
        const handleNext = () => {
          setCurrentProblem(null);
          setMetadata(null);
          setSelectedAnswer(null);
          setShowExplanation(false);
          generateProblem();
        };

        // ì •ë‹µë¥  ê³„ì‚°
        const accuracy =
          score.total > 0 ? Math.round((score.correct / score.total) * 100) : 0;

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8 px-4">
            <div className="max-w-4xl mx-auto">
              {/* í—¤ë” */}
              <div className="text-center mb-8">
                <h1 className="text-4xl font-bold text-indigo-900 mb-2">
                  ğŸ“– JLPT N1 ë…í•´ ë¬¸ì œ ìƒì„±ê¸°
                </h1>
                <p className="text-gray-600">
                  AIê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ë§ì¶¤í˜• ë…í•´ ë¬¸ì œ
                </p>
              </div>

              {/* í†µê³„ */}
              <div className="grid md:grid-cols-4 gap-4 mb-6">
                <div className="bg-blue-50 p-4 rounded-lg text-center">
                  <div className="text-lg font-semibold text-blue-800">
                    ì •ë‹µë¥ : {accuracy}%
                  </div>
                  <div className="text-sm text-gray-600">
                    {score.correct} / {score.total}
                  </div>
                </div>
                <div className="bg-green-50 p-4 rounded-lg text-center">
                  <div className="text-lg font-semibold text-green-800">
                    ì—°ì† ì •ë‹µ: {streak}
                  </div>
                  <div className="text-sm text-gray-600">ìµœê³  ê¸°ë¡ ë‹¬ì„±ì¤‘</div>
                </div>
                <div className="bg-purple-50 p-4 rounded-lg text-center">
                  <div className="text-lg font-semibold text-purple-800">
                    ì´ ë¬¸ì œ: {score.total}
                  </div>
                  <div className="text-sm text-gray-600">í•™ìŠµ ì§„í–‰ì¤‘</div>
                </div>
                <div className="bg-orange-50 p-4 rounded-lg text-center">
                  <div className="text-lg font-semibold text-orange-800">
                    {metadata?.source === "ai" ? "ğŸ¤– AI ìƒì„±" : "ğŸ“š ë°±ì—…"}
                  </div>
                  <div className="text-sm text-gray-600">ë¬¸ì œ ì¶œì²˜</div>
                </div>
              </div>

              {/* ë¬¸ì œ ìƒì„± ë²„íŠ¼ */}
              {!currentProblem && (
                <div className="text-center mb-8">
                  <button
                    onClick={generateProblem}
                    disabled={isGenerating}
                    className="bg-indigo-600 text-white px-8 py-4 rounded-lg font-semibold text-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                  >
                    {isGenerating ? (
                      <>
                        <div className="loading-spinner mr-2"></div>
                        ë¬¸ì œ ìƒì„± ì¤‘...
                      </>
                    ) : (
                      "ğŸ² ìƒˆë¡œìš´ ë¬¸ì œ ìƒì„±í•˜ê¸°"
                    )}
                  </button>

                  {apiError && (
                    <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg max-w-md mx-auto">
                      <p className="text-red-700 text-sm">
                        âš ï¸ API ì˜¤ë¥˜: {apiError}
                      </p>
                      <p className="text-red-600 text-xs mt-2">
                        ë°±ì—… ë¬¸ì œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
                      </p>
                    </div>
                  )}
                </div>
              )}

              {/* ë¬¸ì œ í‘œì‹œ */}
              {currentProblem && (
                <div className="fade-in">
                  {/* ì§€ë¬¸ */}
                  <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h2 className="text-xl font-semibold text-gray-800 mb-4">
                      ğŸ“„ ì§€ë¬¸
                    </h2>
                    <div className="text-gray-700 leading-relaxed text-lg border-l-4 border-indigo-500 pl-4">
                      {currentProblem.passage}
                    </div>
                  </div>

                  {/* ë¬¸ì œ */}
                  <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4">
                      â“ {currentProblem.question}
                    </h3>

                    {/* ì„ íƒì§€ */}
                    <div className="space-y-3">
                      {currentProblem.options.map((option, index) => {
                        const isSelected = selectedAnswer === index;
                        const isCorrect =
                          index === currentProblem.correctAnswer;
                        const showResult = showExplanation;

                        let buttonClass =
                          "choice-button w-full text-left p-4 rounded-lg border-2 transition-all ";

                        if (!showResult) {
                          buttonClass +=
                            "border-gray-300 hover:border-indigo-500 hover:bg-indigo-50";
                        } else if (isCorrect) {
                          buttonClass += "selected-correct border-green-500";
                        } else if (isSelected && !isCorrect) {
                          buttonClass += "selected-wrong border-red-500";
                        } else {
                          buttonClass += "border-gray-300 opacity-50";
                        }

                        return (
                          <button
                            key={index}
                            onClick={() => handleSubmit(index)}
                            disabled={showExplanation}
                            className={buttonClass}
                          >
                            <div className="flex items-center">
                              <span className="font-semibold mr-3 text-gray-600">
                                {index + 1}.
                              </span>
                              <span className="flex-1">{option}</span>
                              {showResult && isCorrect && (
                                <span className="ml-2 text-green-600 font-bold">
                                  âœ“ ì •ë‹µ
                                </span>
                              )}
                              {showResult && isSelected && !isCorrect && (
                                <span className="ml-2 text-red-600 font-bold">
                                  âœ—
                                </span>
                              )}
                            </div>
                          </button>
                        );
                      })}
                    </div>
                  </div>

                  {/* í•´ì„¤ */}
                  {showExplanation && (
                    <div className="bg-white p-6 rounded-lg shadow-md mb-6 fade-in">
                      <h3 className="text-lg font-semibold text-gray-800 mb-3">
                        ğŸ’¡ í•´ì„¤
                      </h3>
                      <p className="text-gray-700 mb-4">
                        {currentProblem.explanation}
                      </p>

                      {currentProblem.grammarPoints &&
                        currentProblem.grammarPoints.length > 0 && (
                          <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                            <h4 className="font-semibold text-blue-800 mb-2">
                              ğŸ“ ì£¼ìš” ë¬¸ë²• í¬ì¸íŠ¸
                            </h4>
                            <ul className="list-disc list-inside text-gray-700 space-y-1">
                              {currentProblem.grammarPoints.map(
                                (point, idx) => (
                                  <li key={idx}>{point}</li>
                                )
                              )}
                            </ul>
                          </div>
                        )}

                      <div className="mt-4 text-center">
                        <button
                          onClick={handleNext}
                          className="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors"
                        >
                          â¡ï¸ ë‹¤ìŒ ë¬¸ì œ
                        </button>
                      </div>
                    </div>
                  )}

                  {/* ë©”íƒ€ë°ì´í„° (ê°œë°œììš©) */}
                  {metadata && (
                    <div className="mt-6">
                      <button
                        onClick={() => setShowMetadata(!showMetadata)}
                        className="text-sm text-gray-500 hover:text-gray-700"
                      >
                        {showMetadata ? "â–¼" : "â–¶"} ë¬¸ì œ ì •ë³´ (ê°œë°œììš©)
                      </button>

                      {showMetadata && (
                        <div className="metadata-box mt-2 text-sm">
                          <div className="grid grid-cols-2 gap-2">
                            <div>
                              <strong>ìƒì„± ì‹œê°:</strong>
                              <div>
                                {new Date(metadata.generatedAt).toLocaleString(
                                  "ko-KR"
                                )}
                              </div>
                            </div>
                            <div>
                              <strong>ì†Œìš” ì‹œê°„:</strong>
                              <div>{metadata.generationTimeMs || "N/A"}ms</div>
                            </div>
                            {metadata.parameters?.topic && (
                              <div>
                                <strong>ì£¼ì œ:</strong>
                                <div>{metadata.parameters.topic.topic}</div>
                              </div>
                            )}
                            {metadata.parameters?.genre && (
                              <div>
                                <strong>ì¥ë¥´:</strong>
                                <div>{metadata.parameters.genre.label}</div>
                              </div>
                            )}
                            {metadata.parameters?.length && (
                              <div>
                                <strong>ê¸¸ì´:</strong>
                                <div>{metadata.parameters.length.label}</div>
                              </div>
                            )}
                            {metadata.parameters?.speaker && (
                              <div>
                                <strong>í™”ì:</strong>
                                <div>{metadata.parameters.speaker.label}</div>
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}

              {/* í‘¸í„° */}
              <div className="text-center mt-8 text-sm text-gray-600">
                <p>ğŸ’¡ ë§¤ë²ˆ ìƒˆë¡œìš´ ë¬¸ì œë¡œ ì‹¤ë ¥ì„ í–¥ìƒì‹œí‚¤ì„¸ìš”!</p>
                <p className="mt-2">ë²„ì „ 2.0.1 | /api/generate-reading ì—°ë™</p>
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
