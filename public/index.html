<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JLPT N1 독해 문제 생성기</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .fade-in {
        animation: fadeIn 0.5s ease-out;
      }
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .choice-button {
        transition: all 0.2s;
      }
      .choice-button:hover:not(:disabled) {
        transform: translateX(4px);
      }
      .choice-button.selected-correct {
        background-color: #dcfce7;
        border-color: #16a34a;
      }
      .choice-button.selected-wrong {
        background-color: #fee2e2;
        border-color: #dc2626;
      }
      .metadata-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      function App() {
        // 상태 관리
        const [isGenerating, setIsGenerating] = useState(false);
        const [currentProblem, setCurrentProblem] = useState(null);
        const [metadata, setMetadata] = useState(null);
        const [selectedAnswer, setSelectedAnswer] = useState(null);
        const [showExplanation, setShowExplanation] = useState(false);
        const [score, setScore] = useState({ correct: 0, total: 0 });
        const [streak, setStreak] = useState(0);
        const [problemHistory, setProblemHistory] = useState([]);
        const [apiError, setApiError] = useState(null);
        const [showMetadata, setShowMetadata] = useState(false);

        // 로컬스토리지에서 데이터 로드
        useEffect(() => {
          const savedScore = localStorage.getItem("jlpt-reading-score");
          const savedStreak = localStorage.getItem("jlpt-reading-streak");
          const savedHistory = localStorage.getItem("jlpt-reading-history");

          if (savedScore) setScore(JSON.parse(savedScore));
          if (savedStreak) setStreak(parseInt(savedStreak));
          if (savedHistory) setProblemHistory(JSON.parse(savedHistory));
        }, []);

        // 데이터 저장
        const saveData = (newScore, newStreak, newHistory) => {
          localStorage.setItem("jlpt-reading-score", JSON.stringify(newScore));
          localStorage.setItem("jlpt-reading-streak", newStreak.toString());
          localStorage.setItem(
            "jlpt-reading-history",
            JSON.stringify(newHistory)
          );
        };

        // 문제 생성 함수
        const generateProblem = async () => {
          setIsGenerating(true);
          setApiError(null);
          setCurrentProblem(null);
          setMetadata(null);
          setSelectedAnswer(null);
          setShowExplanation(false);

          try {
            // generate-reading.js의 함수 호출
            const result = await window.generateReadingProblem();

            if (result.problem) {
              setCurrentProblem(result.problem);
              setMetadata(result.metadata);
              console.log("✅ 문제 생성 성공:", result);
            } else {
              throw new Error("문제 생성 결과가 없습니다");
            }
          } catch (error) {
            console.error("❌ 문제 생성 오류:", error);
            setApiError(error.message);

            // 백업 문제 사용
            setCurrentProblem({
              passage:
                "人工知能の発展により、私たちの生活は大きく変わりつつある。しかし、技術の進歩が必ずしも人間の幸福につながるとは限らない。むしろ、技術に依存しすぎることで、人間本来の能力が衰退する危険性もある。重要なのは、技術を適切に活用しながら、人間らしさを保つバランスを見つけることである。",
              question: "この文章の主張として最も適切なものはどれか。",
              options: [
                "人工知能の発展は人間の幸福に直結する",
                "技術の進歩により人間の能力は向上する",
                "技術と人間性のバランスが重要である",
                "技術への依存を完全に避けるべきである",
              ],
              correctAnswer: 2,
              explanation:
                "筆者は技術の適切な活用と人間らしさの保持のバランスが重要だと主張しています。",
              grammarPoints: ["～につながる", "～とは限らない", "むしろ～"],
              vocabularyLevel: "N1",
            });
            setMetadata({
              source: "fallback",
              generatedAt: new Date().toISOString(),
            });
          } finally {
            setIsGenerating(false);
          }
        };

        // 답안 제출
        const handleSubmit = (answerIndex) => {
          if (selectedAnswer !== null || !currentProblem) return;

          setSelectedAnswer(answerIndex);
          setShowExplanation(true);

          const isCorrect = answerIndex === currentProblem.correctAnswer;
          const newScore = {
            correct: score.correct + (isCorrect ? 1 : 0),
            total: score.total + 1,
          };
          const newStreak = isCorrect ? streak + 1 : 0;

          const historyEntry = {
            timestamp: new Date().toISOString(),
            correct: isCorrect,
            problem: currentProblem.question,
            metadata: metadata,
          };
          const newHistory = [historyEntry, ...problemHistory].slice(0, 50);

          setScore(newScore);
          setStreak(newStreak);
          setProblemHistory(newHistory);
          saveData(newScore, newStreak, newHistory);
        };

        // 다음 문제
        const handleNext = () => {
          setCurrentProblem(null);
          setMetadata(null);
          setSelectedAnswer(null);
          setShowExplanation(false);
          generateProblem();
        };

        // 정답률 계산
        const accuracy =
          score.total > 0 ? Math.round((score.correct / score.total) * 100) : 0;

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8 px-4">
            <div className="max-w-4xl mx-auto">
              {/* 헤더 */}
              <div className="text-center mb-8">
                <h1 className="text-4xl font-bold text-indigo-900 mb-2">
                  📖 JLPT N1 독해 문제 생성기
                </h1>
                <p className="text-gray-600">
                  AI가 실시간으로 생성하는 맞춤형 독해 문제
                </p>
                <div className="mt-4 flex justify-center gap-4 text-sm flex-wrap">
                  <a
                    href="kanji-generator.html"
                    className="bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600 transition-colors"
                  >
                    🔤 한자 문제
                  </a>
                  <a
                    href="grammar-generator.html"
                    className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors"
                  >
                    📚 문법 문제
                  </a>
                  <a
                    href="vocabulary-generator.html"
                    className="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition-colors"
                  >
                    💭 어휘 문제
                  </a>
                  <a
                    href="mixed-generator.html"
                    className="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition-colors"
                  >
                    🎯 통합 문제
                  </a>
                  <a
                    href="stats.html"
                    className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition-colors"
                  >
                    📊 학습 통계
                  </a>
                </div>
              </div>

              {/* 통계 */}
              <div className="grid md:grid-cols-4 gap-4 mb-6">
                <div className="bg-blue-50 p-4 rounded-lg text-center">
                  <div className="text-lg font-semibold text-blue-800">
                    정답률: {accuracy}%
                  </div>
                  <div className="text-sm text-gray-600">
                    {score.correct} / {score.total}
                  </div>
                </div>
                <div className="bg-green-50 p-4 rounded-lg text-center">
                  <div className="text-lg font-semibold text-green-800">
                    연속 정답: {streak}
                  </div>
                  <div className="text-sm text-gray-600">최고 기록 달성중</div>
                </div>
                <div className="bg-purple-50 p-4 rounded-lg text-center">
                  <div className="text-lg font-semibold text-purple-800">
                    총 문제: {score.total}
                  </div>
                  <div className="text-sm text-gray-600">학습 진행중</div>
                </div>
                <div className="bg-orange-50 p-4 rounded-lg text-center">
                  <div className="text-lg font-semibold text-orange-800">
                    {metadata?.source === "ai" ? "🤖 AI 생성" : "📚 백업"}
                  </div>
                  <div className="text-sm text-gray-600">문제 출처</div>
                </div>
              </div>

              {/* 문제 생성 버튼 */}
              {!currentProblem && (
                <div className="text-center mb-8">
                  <button
                    onClick={generateProblem}
                    disabled={isGenerating}
                    className="bg-indigo-600 text-white px-8 py-4 rounded-lg font-semibold text-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                  >
                    {isGenerating ? (
                      <>
                        <div className="loading-spinner mr-2"></div>
                        문제 생성 중...
                      </>
                    ) : (
                      "🎲 새로운 문제 생성하기"
                    )}
                  </button>

                  {apiError && (
                    <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg max-w-md mx-auto">
                      <p className="text-red-700 text-sm">
                        ⚠️ API 오류: {apiError}
                      </p>
                      <p className="text-red-600 text-xs mt-2">
                        백업 문제를 사용합니다. 잠시 후 다시 시도해주세요.
                      </p>
                    </div>
                  )}
                </div>
              )}

              {/* 문제 표시 */}
              {currentProblem && (
                <div className="fade-in">
                  {/* 지문 */}
                  <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h2 className="text-xl font-semibold text-gray-800 mb-4">
                      📄 지문
                    </h2>
                    <div className="text-gray-700 leading-relaxed text-lg border-l-4 border-indigo-500 pl-4">
                      {currentProblem.passage}
                    </div>
                  </div>

                  {/* 문제 */}
                  <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4">
                      ❓ {currentProblem.question}
                    </h3>

                    {/* 선택지 */}
                    <div className="space-y-3">
                      {currentProblem.options.map((option, index) => {
                        const isSelected = selectedAnswer === index;
                        const isCorrect =
                          index === currentProblem.correctAnswer;
                        const showResult = showExplanation;

                        let buttonClass =
                          "choice-button w-full text-left p-4 rounded-lg border-2 transition-all ";

                        if (!showResult) {
                          buttonClass +=
                            "border-gray-300 hover:border-indigo-500 hover:bg-indigo-50";
                        } else if (isCorrect) {
                          buttonClass += "selected-correct border-green-500";
                        } else if (isSelected && !isCorrect) {
                          buttonClass += "selected-wrong border-red-500";
                        } else {
                          buttonClass += "border-gray-300 opacity-50";
                        }

                        return (
                          <button
                            key={index}
                            onClick={() => handleSubmit(index)}
                            disabled={showExplanation}
                            className={buttonClass}
                          >
                            <div className="flex items-center">
                              <span className="font-semibold mr-3 text-gray-600">
                                {index + 1}.
                              </span>
                              <span className="flex-1">{option}</span>
                              {showResult && isCorrect && (
                                <span className="ml-2 text-green-600 font-bold">
                                  ✓ 정답
                                </span>
                              )}
                              {showResult && isSelected && !isCorrect && (
                                <span className="ml-2 text-red-600 font-bold">
                                  ✗
                                </span>
                              )}
                            </div>
                          </button>
                        );
                      })}
                    </div>
                  </div>

                  {/* 해설 */}
                  {showExplanation && (
                    <div className="bg-white p-6 rounded-lg shadow-md mb-6 fade-in">
                      <h3 className="text-lg font-semibold text-gray-800 mb-3">
                        💡 해설
                      </h3>
                      <p className="text-gray-700 mb-4">
                        {currentProblem.explanation}
                      </p>

                      {currentProblem.grammarPoints &&
                        currentProblem.grammarPoints.length > 0 && (
                          <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                            <h4 className="font-semibold text-blue-800 mb-2">
                              📝 주요 문법 포인트
                            </h4>
                            <ul className="list-disc list-inside text-gray-700 space-y-1">
                              {currentProblem.grammarPoints.map(
                                (point, idx) => (
                                  <li key={idx}>{point}</li>
                                )
                              )}
                            </ul>
                          </div>
                        )}

                      <div className="mt-4 text-center">
                        <button
                          onClick={handleNext}
                          className="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors"
                        >
                          ➡️ 다음 문제
                        </button>
                      </div>
                    </div>
                  )}

                  {/* 메타데이터 (개발자용) */}
                  {metadata && (
                    <div className="mt-6">
                      <button
                        onClick={() => setShowMetadata(!showMetadata)}
                        className="text-sm text-gray-500 hover:text-gray-700"
                      >
                        {showMetadata ? "▼" : "▶"} 문제 정보 (개발자용)
                      </button>

                      {showMetadata && (
                        <div className="metadata-box mt-2 text-sm">
                          <div className="grid grid-cols-2 gap-2">
                            <div>
                              <strong>생성 시각:</strong>
                              <div>
                                {new Date(metadata.generatedAt).toLocaleString(
                                  "ko-KR"
                                )}
                              </div>
                            </div>
                            <div>
                              <strong>소요 시간:</strong>
                              <div>{metadata.generationTimeMs}ms</div>
                            </div>
                            {metadata.parameters?.topic && (
                              <div>
                                <strong>주제:</strong>
                                <div>{metadata.parameters.topic.topic}</div>
                              </div>
                            )}
                            {metadata.parameters?.genre && (
                              <div>
                                <strong>장르:</strong>
                                <div>{metadata.parameters.genre.label}</div>
                              </div>
                            )}
                            {metadata.parameters?.length && (
                              <div>
                                <strong>길이:</strong>
                                <div>{metadata.parameters.length.label}</div>
                              </div>
                            )}
                            {metadata.parameters?.speaker && (
                              <div>
                                <strong>화자:</strong>
                                <div>{metadata.parameters.speaker.label}</div>
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}

              {/* 푸터 */}
              <div className="text-center mt-8 text-sm text-gray-600">
                <p>💡 매번 새로운 문제로 실력을 향상시키세요!</p>
                <p className="mt-2">
                  버전 2.0.0 | generate-reading.js 완전 연동
                </p>
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("root"));
    </script>

    <!-- generate-reading.js 로드 -->
    <script src="api/generate-reading.js"></script>
  </body>
</html>
