<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>JLPT N1 리딩 문제 생성기</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        font-family: system-ui, sans-serif;
      }
      body {
        margin: 0;
        padding: 24px;
        background: #0b0c10;
        color: #eaf0f1;
      }
      .wrap {
        max-width: 860px;
        margin: 0 auto;
      }
      h1 {
        font-size: 20px;
        margin: 0 0 16px;
      }
      .card {
        background: #14171a;
        border: 1px solid #2b3137;
        border-radius: 14px;
        padding: 18px;
        margin-bottom: 16px;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .row > * {
        flex: 1 1 200px;
      }
      label {
        display: block;
        font-size: 12px;
        color: #9aa5b1;
        margin-bottom: 6px;
      }
      select,
      input[type="text"] {
        width: 100%;
        padding: 10px 12px;
        background: #0f1113;
        color: #eaf0f1;
        border: 1px solid #2b3137;
        border-radius: 10px;
        outline: none;
      }
      button {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #2b3137;
        background: #0f1113;
        color: #eaf0f1;
        cursor: pointer;
      }
      button.primary {
        background: #1f6feb;
        border-color: #1f6feb;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .muted {
        color: #9aa5b1;
        font-size: 12px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .problem {
        white-space: pre-wrap;
      }
      .options li {
        margin: 6px 0;
      }
      .hidden {
        display: none;
      }
      .error {
        color: #ff7070;
      }
      .ok {
        color: #5bd08d;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>JLPT N1 리딩 문제 생성 (API 호출 방식)</h1>

      <div class="card">
        <div class="row">
          <div>
            <label>Topic (선택/옵션)</label>
            <input id="topic" type="text" placeholder="예: 교육, 과학, 사회…" />
          </div>
          <div>
            <label>Length (선택/옵션)</label>
            <select id="length">
              <option value="">자동</option>
              <option value="short">short</option>
              <option value="medium">medium</option>
              <option value="long">long</option>
            </select>
          </div>
          <div>
            <label>Speaker/Tone (선택/옵션)</label>
            <input
              id="speaker"
              type="text"
              placeholder="예: professor, editor, student…"
            />
          </div>
        </div>
        <div class="row" style="margin-top: 12px">
          <button id="btn-generate" class="primary">문제 생성</button>
          <button id="btn-reset">리셋</button>
          <span id="status" class="muted"></span>
        </div>
      </div>

      <div id="result" class="card hidden">
        <div class="muted">생성 결과</div>
        <h2 style="margin: 8px 0 6px">지문</h2>
        <div id="passage" class="problem"></div>

        <h2 style="margin: 16px 0 6px">문항</h2>
        <div id="question" class="problem"></div>

        <h3 style="margin: 12px 0 6px">보기</h3>
        <ol id="options" class="options"></ol>

        <details style="margin-top: 12px">
          <summary>정답 / 해설 보기</summary>
          <p id="answer" class="mono"></p>
          <p id="explanation" class="problem"></p>
        </details>
      </div>

      <div class="card">
        <div class="muted">콘솔 상태</div>
        <pre
          id="console"
          class="mono"
          style="
            background: #0b0c10;
            padding: 10px;
            border-radius: 8px;
            overflow: auto;
            max-height: 220px;
          "
        ></pre>
      </div>
    </div>

    <script>
      // ========= 핵심: 프런트에서 서버 API를 호출하는 래퍼 =========
      // 백엔드(/api/generate-reading)에서 문제 JSON을 만들어 주고,
      // 프런트는 fetch로 받아서 UI에 뿌린다.
      async function generateProblemViaAPI(payload) {
        const res = await fetch("/api/generate-reading", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload || {}),
        });
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`API ${res.status}: ${text || "요청 실패"}`);
        }
        return res.json(); // { passage, question, options, correctAnswer, explanation }
      }

      // 선택적으로 기존 코드 호환: window.generateReadingProblem 이 필요하다면 이렇게 노출
      window.generateReadingProblem = async function (payload) {
        return generateProblemViaAPI(payload);
      };

      // ========= UI 바인딩 =========
      (function () {
        const $ = (s) => document.querySelector(s);
        const log = (msg) => {
          const el = $("#console");
          const time = new Date().toLocaleTimeString();
          el.textContent += `[${time}] ${msg}\n`;
          el.scrollTop = el.scrollHeight;
        };

        document.addEventListener("DOMContentLoaded", () => {
          log("content loaded");

          const btnGen = $("#btn-generate");
          const btnReset = $("#btn-reset");
          const status = $("#status");

          const $topic = $("#topic");
          const $length = $("#length");
          const $speaker = $("#speaker");

          const $result = $("#result");
          const $passage = $("#passage");
          const $question = $("#question");
          const $options = $("#options");
          const $answer = $("#answer");
          const $explanation = $("#explanation");

          // 기존 진단 로그와 최대한 호환
          if (typeof window.generateReadingProblem === "function") {
            log("✅ generateReadingProblem 함수 체크: 있음");
            status.textContent = "ready";
            status.className = "muted ok";
          } else {
            log("❌ generateReadingProblem 함수 체크: 없음");
            status.textContent = "함수 미로딩";
            status.className = "muted error";
          }

          btnGen.addEventListener("click", async () => {
            btnGen.disabled = true;
            status.textContent = "생성 중...";
            status.className = "muted";

            try {
              const payload = {};
              if ($topic.value.trim()) payload.topic = $topic.value.trim();
              if ($length.value) payload.length = $length.value;
              if ($speaker.value.trim())
                payload.speaker = $speaker.value.trim();

              const data = await window.generateReadingProblem(payload);

              // 기대 구조: { passage, question, options, correctAnswer, explanation }
              const { passage, question, options, correctAnswer, explanation } =
                data || {};
              if (!passage || !question || !Array.isArray(options)) {
                throw new Error("API 응답 포맷이 올바르지 않습니다.");
              }

              $passage.textContent = passage;
              $question.textContent = question;
              $options.innerHTML = "";
              options.forEach((opt, idx) => {
                const li = document.createElement("li");
                li.textContent = opt;
                $options.appendChild(li);
              });

              // 정답/해설(있으면 표시)
              $answer.textContent =
                typeof correctAnswer === "number"
                  ? `정답 번호: ${correctAnswer + 1}`
                  : correctAnswer
                  ? String(correctAnswer)
                  : "(미제공)";
              $explanation.textContent = explanation || "(해설 없음)";

              $result.classList.remove("hidden");
              status.textContent = "완료";
              status.className = "muted ok";
              log("✅ 문제 생성 성공");
            } catch (err) {
              const msg = err?.message || String(err);
              log(`❌ 문제 생성 오류: ${msg}`);
              status.textContent = "오류";
              status.className = "muted error";
              alert("문제 생성 중 오류가 발생했습니다.\n" + msg);
            } finally {
              btnGen.disabled = false;
            }
          });

          btnReset.addEventListener("click", () => {
            $topic.value = "";
            $length.value = "";
            $speaker.value = "";
            $result.classList.add("hidden");
            $passage.textContent = "";
            $question.textContent = "";
            $options.innerHTML = "";
            $answer.textContent = "";
            $explanation.textContent = "";
            status.textContent = "ready";
            status.className = "muted ok";
            log("리셋 완료");
          });
        });
      })();
    </script>
  </body>
</html>
