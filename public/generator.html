<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JLPT N1 ë¬¸ì œ ìƒì„±ê¸°</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-white">
    <main id="generator-root" class="max-w-6xl mx-auto p-6"></main>

    <script type="text/babel">
      const { useState, useEffect } = React;

      const TopicGenreGenerator = () => {
        const [topics, setTopics] = useState(null);
        const [genres, setGenres] = useState(null);
        const [currentPrompt, setCurrentPrompt] = useState(null);
        const [generatedEssay, setGeneratedEssay] = useState(null);
        const [isGenerating, setIsGenerating] = useState(false);
        const [history, setHistory] = useState([]);

        useEffect(() => {
          const loadData = async () => {
            try {
              const topicsData = await fetch("topics.json").then((res) =>
                res.json()
              );
              setTopics(topicsData);
              const genresData = await fetch("genre.json").then((res) =>
                res.json()
              );
              setGenres(genresData);
            } catch (error) {
              console.error("JSON ë¡œë”© ì‹¤íŒ¨:", error);
            }
          };
          loadData();
        }, []);

        const getRandomTopic = () => {
          if (!topics?.topics) return null;
          const keys = Object.keys(topics.topics);
          const category =
            topics.topics[keys[Math.floor(Math.random() * keys.length)]];
          const topic =
            category.items[Math.floor(Math.random() * category.items.length)];
          return { category: category.category, topic };
        };

        const getRandomGenre = () => {
          if (!genres?.length) return null;
          return genres[Math.floor(Math.random() * genres.length)];
        };

        const createFullPrompt = (topic, genre) =>
          `JLPT N1 ìˆ˜ì¤€ì˜ ${
            genre.label
          } ì‘ì„± ê³¼ì œë¥¼ ì•„ë˜ í˜•ì‹ê³¼ ì¡°ê±´ì— ë§ì¶”ì–´ JSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì£¼ì„¸ìš”.\n\n**ì£¼ì œ**: ${
            topic.topic
          }\n**ì¹´í…Œê³ ë¦¬**: ${topic.category}\n**ì¥ë¥´**: ${
            genre.label
          }\n\n**ì¥ë¥´ íŠ¹ì§•**:\n${genre.features
            .map((f) => `â€¢ ${f}`)
            .join("\\n")}\n\n**ì‘ì„± ì§€ì¹¨**:\n${genre.description}\n\n${
            genre.instructions
          }\n\n**ìš”êµ¬ì‚¬í•­**:\nâ€¢ ë°˜ë“œì‹œ ì˜¬ë°”ë¥¸ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ (ì½”ë“œë¸”ë¡ ê¸ˆì§€, í•´ì„¤ ê¸ˆì§€)\nâ€¢ ë³¸ë¬¸ì€ 100~150ì ì¼ë³¸ì–´\nâ€¢ N1 ìˆ˜ì¤€ì˜ ê³ ê¸‰ ì–´íœ˜ì™€ ë¬¸ë²• ì‚¬ìš©\nâ€¢ ë…¼ë¦¬ì ì´ê³  ì¼ê´€ì„± ìˆëŠ” êµ¬ì„±\nâ€¢ ì£¼ì œì— ëŒ€í•œ ê¹Šì´ ìˆëŠ” ì‚¬ê³ ì™€ ë¶„ì„ í¬í•¨\nâ€¢ ì¼ë³¸ì–´ ì›ì–´ë¯¼ ìˆ˜ì¤€ì˜ ìì—°ìŠ¤ëŸ¬ìš´ í‘œí˜„ ì‚¬ìš©\n\n**ì¶œë ¥ í˜•ì‹(JSON)**:\n{\n  \"type\": \"reading\",\n  \"topic\": \"<ì£¼ì œëª… ê·¸ëŒ€ë¡œ>\",\n  \"passage\": \"<100~150ì ì§€ë¬¸>\",\n  \"question\": \"<ì§€ë¬¸ì— ëŒ€í•œ ê³ ì°¨ì›ì  ì§ˆë¬¸>\",\n  \"choices\": [\"ì„ íƒì§€1\", \"ì„ íƒì§€2\", \"ì„ íƒì§€3\", \"ì„ íƒì§€4\"],\n  \"correct\": <0~3 ì¤‘ ì •ë‹µ ì¸ë±ìŠ¤>,\n  \"explanation\": \"<í•œêµ­ì–´ë¡œ ëœ ì •ë‹µ í•´ì„¤>\"\n}`;

        const generatePrompt = async () => {
          setIsGenerating(true);
          setGeneratedEssay(null);
          const topic = getRandomTopic();
          const genre = getRandomGenre();
          if (!topic || !genre) {
            setIsGenerating(false);
            return;
          }

          const fullPrompt = createFullPrompt(topic, genre);

          const prompt = {
            id: Date.now(),
            topic,
            genre,
            fullPrompt,
            generatedAt: new Date().toLocaleString("ko-KR"),
          };
          setCurrentPrompt(prompt);
          setHistory((prev) => [prompt, ...prev.slice(0, 9)]);

          try {
            const res = await fetch("/api/generate-reading", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ prompt: fullPrompt }),
            });

            const text = await res.text();
            let data;
            try {
              const jsonStart = text.indexOf("{");
              const jsonEnd = text.lastIndexOf("}");
              if (jsonStart === -1 || jsonEnd === -1 || jsonEnd <= jsonStart) {
                throw new Error("ìœ íš¨í•œ JSON ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              }
              const jsonContent = text.slice(jsonStart, jsonEnd + 1);
              data = JSON.parse(jsonContent);
            } catch (err) {
              console.error("JSON íŒŒì‹± ì‹¤íŒ¨:", err);
              throw new Error(`ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ${text}`);
            }

            if (data.success) {
              setGeneratedEssay(data.result);
            } else {
              setGeneratedEssay(`[ì˜¤ë¥˜] ${data.error || "ìƒì„± ì‹¤íŒ¨"}`);
            }
          } catch (error) {
            console.error("API í˜¸ì¶œ ì‹¤íŒ¨:", error);
            setGeneratedEssay("[API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ]");
          }

          setIsGenerating(false);
        };

        return (
          <div>
            <h1 className="text-3xl font-bold text-center mb-6">
              ğŸ² JLPT N1 í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°
            </h1>
            <div className="text-center mb-4">
              <button
                onClick={generatePrompt}
                disabled={isGenerating}
                className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded"
              >
                {isGenerating ? "ìƒì„± ì¤‘..." : "í”„ë¡¬í”„íŠ¸ ìƒì„± ë° AI ì‘ë¬¸"}
              </button>
            </div>

            {currentPrompt && (
              <div className="bg-gray-50 border p-4 rounded mb-6">
                <h2 className="text-xl font-semibold mb-2">
                  ğŸ“ ìƒì„±ëœ í”„ë¡¬í”„íŠ¸
                </h2>
                <pre className="whitespace-pre-wrap text-sm bg-white p-3 rounded border text-gray-800">
                  {currentPrompt.fullPrompt}
                </pre>
                <p className="text-xs text-right text-gray-500 mt-2">
                  {currentPrompt.generatedAt}
                </p>
              </div>
            )}

            {generatedEssay && (
              <div className="bg-green-50 border p-4 rounded mb-6">
                <h2 className="text-xl font-semibold mb-2">ğŸ“„ AI ì‘ì„± ê²°ê³¼</h2>
                <p className="whitespace-pre-wrap text-gray-800 leading-relaxed">
                  {generatedEssay}
                </p>
              </div>
            )}

            {history.length > 0 && (
              <div className="mt-6">
                <h3 className="text-lg font-semibold mb-2">ğŸ“œ ìƒì„± ì´ë ¥</h3>
                <ul className="text-sm space-y-2">
                  {history.map((item) => (
                    <li key={item.id} className="bg-white p-2 rounded border">
                      <strong>{item.genre.label}</strong> - {item.topic.topic}
                      <br />
                      <span className="text-gray-500 text-xs">
                        {item.generatedAt}
                      </span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("generator-root")).render(
        <TopicGenreGenerator />
      );
    </script>
  </body>
</html>
