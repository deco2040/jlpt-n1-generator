<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Topic Genre Generator</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-white">
    <div id="generator-root" class="max-w-6xl mx-auto p-6"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      const TopicGenreGenerator = () => {
        const [topics, setTopics] = useState(null);
        const [genres, setGenres] = useState(null);
        const [currentPrompt, setCurrentPrompt] = useState(null);
        const [generatedEssay, setGeneratedEssay] = useState(null);
        const [isGenerating, setIsGenerating] = useState(false);
        const [history, setHistory] = useState([]);

        useEffect(() => {
          const loadData = async () => {
            try {
              const topicsData = await fetch("topics.json").then((res) =>
                res.json()
              );
              setTopics(topicsData);
              const genresData = await fetch("genre.json").then((res) =>
                res.json()
              );
              setGenres(genresData);
            } catch (error) {
              console.error("JSON ë¡œë”© ì‹¤íŒ¨:", error);
            }
          };
          loadData();
        }, []);

        const getRandomTopic = () => {
          if (!topics?.topics) return null;
          const keys = Object.keys(topics.topics);
          const category =
            topics.topics[keys[Math.floor(Math.random() * keys.length)]];
          const topic =
            category.items[Math.floor(Math.random() * category.items.length)];
          return { category: category.category, topic };
        };

        const getRandomGenre = () => {
          if (!genres?.length) return null;
          return genres[Math.floor(Math.random() * genres.length)];
        };

        const createFullPrompt = (topic, genre) =>
          "âš ï¸ JSON ONLY. No explanations or greetings.\n"`JLPT N1 ìˆ˜ì¤€ì˜ ${
            genre.label
          } ì‘ì„± ê³¼ì œ\n\n**ì£¼ì œ**: ${topic.topic}\n**ì¹´í…Œê³ ë¦¬**: ${
            topic.category
          }\n**ì¥ë¥´**: ${genre.label}\n\n**ì¥ë¥´ íŠ¹ì§•**:\n${genre.features
            .map((f) => `â€¢ ${f}`)
            .join("\n")}\n\n**ì‘ì„± ì§€ì¹¨**:\n${genre.description}\n\n${
            genre.instructions
          }\n\n**ìš”êµ¬ì‚¬í•­**:\nâ€¢ 100-150ì ë¶„ëŸ‰\nâ€¢ N1 ìˆ˜ì¤€ì˜ ê³ ê¸‰ ì–´íœ˜ì™€ ë¬¸ë²• ì‚¬ìš©\nâ€¢ ë…¼ë¦¬ì ì´ê³  ì¼ê´€ì„± ìˆëŠ” êµ¬ì„±\nâ€¢ ì£¼ì œì— ëŒ€í•œ ê¹Šì´ ìˆëŠ” ì‚¬ê³ ì™€ ë¶„ì„\nâ€¢ ì¼ë³¸ì–´ ì›ì–´ë¯¼ ìˆ˜ì¤€ì˜ ìì—°ìŠ¤ëŸ¬ìš´ í‘œí˜„`;

        const generatePrompt = async () => {
          setIsGenerating(true);
          setGeneratedEssay(null);
          const topic = getRandomTopic();
          const genre = getRandomGenre();
          if (!topic || !genre) return setIsGenerating(false);

          const fullPrompt = createFullPrompt(topic, genre);

          const prompt = {
            id: Date.now(),
            topic,
            genre,
            fullPrompt,
            generatedAt: new Date().toLocaleString("ko-KR"),
          };
          setCurrentPrompt(prompt);
          setHistory((prev) => [prompt, ...prev.slice(0, 9)]);

          try {
            const res = await fetch("/api/generate-reading", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ prompt: fullPrompt }),
            });
            const data = await res.json();
            if (data.success) {
              setGeneratedEssay(data.result);
            } else {
              setGeneratedEssay(`[ì˜¤ë¥˜] ${data.error || "ìƒì„± ì‹¤íŒ¨"}`);
            }
          } catch (error) {
            console.error("API í˜¸ì¶œ ì‹¤íŒ¨:", error);
            setGeneratedEssay("[API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ]");
          }

          setIsGenerating(false);
        };

        return (
          <div>
            <h1 className="text-3xl font-bold text-center mb-6">
              ğŸ² JLPT N1 í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°
            </h1>
            <div className="text-center mb-4">
              <button
                onClick={generatePrompt}
                disabled={isGenerating}
                className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded"
              >
                {isGenerating ? "ìƒì„± ì¤‘..." : "í”„ë¡¬í”„íŠ¸ ìƒì„± ë° AI ì‘ë¬¸"}
              </button>
            </div>

            {currentPrompt && (
              <div className="bg-gray-50 border p-4 rounded mb-6">
                <h2 className="text-xl font-semibold mb-2">
                  ğŸ“ ìƒì„±ëœ í”„ë¡¬í”„íŠ¸
                </h2>
                <pre className="whitespace-pre-wrap text-sm bg-white p-3 rounded border text-gray-800">
                  {currentPrompt.fullPrompt}
                </pre>
                <p className="text-xs text-right text-gray-500 mt-2">
                  {currentPrompt.generatedAt}
                </p>
              </div>
            )}

            {generatedEssay && (
              <div className="bg-green-50 border p-4 rounded mb-6">
                <h2 className="text-xl font-semibold mb-2">ğŸ“„ AI ì‘ì„± ê²°ê³¼</h2>
                <p className="whitespace-pre-wrap text-gray-800 leading-relaxed">
                  {generatedEssay}
                </p>
              </div>
            )}

            {history.length > 0 && (
              <div className="mt-6">
                <h3 className="text-lg font-semibold mb-2">ğŸ“œ ìƒì„± ì´ë ¥</h3>
                <ul className="text-sm space-y-2">
                  {history.map((item) => (
                    <li key={item.id} className="bg-white p-2 rounded border">
                      <strong>{item.genre.label}</strong> - {item.topic.topic}
                      <br />
                      <span className="text-gray-500 text-xs">
                        {item.generatedAt}
                      </span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("generator-root")).render(
        <TopicGenreGenerator />
      );
    </script>
  </body>
</html>
