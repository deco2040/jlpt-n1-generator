<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JLPT N1 문제 생성기</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-white">
    <main id="generator-root" class="max-w-6xl mx-auto p-6"></main>

    <script type="text/babel">
      const { useState, useEffect } = React;

      const TopicGenreGenerator = () => {
        const [topics, setTopics] = useState(null);
        const [genres, setGenres] = useState(null);
        const [currentPrompt, setCurrentPrompt] = useState(null);
        const [generatedEssay, setGeneratedEssay] = useState(null);
        const [isGenerating, setIsGenerating] = useState(false);
        const [history, setHistory] = useState([]);

        useEffect(() => {
          const loadData = async () => {
            try {
              const topicsData = await fetch("topics.json").then((res) =>
                res.json()
              );
              setTopics(topicsData);
              const genresData = await fetch("genre.json").then((res) =>
                res.json()
              );
              setGenres(genresData);
            } catch (error) {
              console.error("JSON 로딩 실패:", error);
            }
          };
          loadData();
        }, []);

        const getRandomTopic = () => {
          if (!topics?.topics) return null;
          const keys = Object.keys(topics.topics);
          const category =
            topics.topics[keys[Math.floor(Math.random() * keys.length)]];
          const topic =
            category.items[Math.floor(Math.random() * category.items.length)];
          return { category: category.category, topic };
        };

        const getRandomGenre = () => {
          if (!genres?.length) return null;
          return genres[Math.floor(Math.random() * genres.length)];
        };

        const createFullPrompt = (topic, genre) =>
          `JLPT N1 수준의 ${
            genre.label
          } 작성 과제를 아래 형식과 조건에 맞추어 JSON 형식으로 출력해주세요.\n\n**주제**: ${
            topic.topic
          }\n**카테고리**: ${topic.category}\n**장르**: ${
            genre.label
          }\n\n**장르 특징**:\n${genre.features
            .map((f) => `• ${f}`)
            .join("\\n")}\n\n**작성 지침**:\n${genre.description}\n\n${
            genre.instructions
          }\n\n**요구사항**:\n• 반드시 올바른 JSON 형식으로만 응답 (코드블록 금지, 해설 금지)\n• 본문은 100~150자 일본어\n• N1 수준의 고급 어휘와 문법 사용\n• 논리적이고 일관성 있는 구성\n• 주제에 대한 깊이 있는 사고와 분석 포함\n• 일본어 원어민 수준의 자연스러운 표현 사용\n\n**출력 형식(JSON)**:\n{\n  \"type\": \"reading\",\n  \"topic\": \"<주제명 그대로>\",\n  \"passage\": \"<100~150자 지문>\",\n  \"question\": \"<지문에 대한 고차원적 질문>\",\n  \"choices\": [\"선택지1\", \"선택지2\", \"선택지3\", \"선택지4\"],\n  \"correct\": <0~3 중 정답 인덱스>,\n  \"explanation\": \"<한국어로 된 정답 해설>\"\n}`;

        const generatePrompt = async () => {
          setIsGenerating(true);
          setGeneratedEssay(null);
          const topic = getRandomTopic();
          const genre = getRandomGenre();
          if (!topic || !genre) {
            setIsGenerating(false);
            return;
          }

          const fullPrompt = createFullPrompt(topic, genre);

          const prompt = {
            id: Date.now(),
            topic,
            genre,
            fullPrompt,
            generatedAt: new Date().toLocaleString("ko-KR"),
          };
          setCurrentPrompt(prompt);
          setHistory((prev) => [prompt, ...prev.slice(0, 9)]);

          try {
            const res = await fetch("/api/generate-reading", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ prompt: fullPrompt }),
            });

            const text = await res.text();
            let data;
            try {
              const jsonStart = text.indexOf("{");
              const jsonEnd = text.lastIndexOf("}");
              if (jsonStart === -1 || jsonEnd === -1 || jsonEnd <= jsonStart) {
                throw new Error("유효한 JSON 블록을 찾을 수 없습니다.");
              }
              const jsonContent = text.slice(jsonStart, jsonEnd + 1);
              data = JSON.parse(jsonContent);
            } catch (err) {
              console.error("JSON 파싱 실패:", err);
              throw new Error(`응답 파싱 실패: ${text}`);
            }

            if (data.success) {
              setGeneratedEssay(data.result);
            } else {
              setGeneratedEssay(`[오류] ${data.error || "생성 실패"}`);
            }
          } catch (error) {
            console.error("API 호출 실패:", error);
            setGeneratedEssay("[API 호출 중 오류 발생]");
          }

          setIsGenerating(false);
        };

        return (
          <div>
            <h1 className="text-3xl font-bold text-center mb-6">
              🎲 JLPT N1 프롬프트 생성기
            </h1>
            <div className="text-center mb-4">
              <button
                onClick={generatePrompt}
                disabled={isGenerating}
                className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded"
              >
                {isGenerating ? "생성 중..." : "프롬프트 생성 및 AI 작문"}
              </button>
            </div>

            {currentPrompt && (
              <div className="bg-gray-50 border p-4 rounded mb-6">
                <h2 className="text-xl font-semibold mb-2">
                  📝 생성된 프롬프트
                </h2>
                <pre className="whitespace-pre-wrap text-sm bg-white p-3 rounded border text-gray-800">
                  {currentPrompt.fullPrompt}
                </pre>
                <p className="text-xs text-right text-gray-500 mt-2">
                  {currentPrompt.generatedAt}
                </p>
              </div>
            )}

            {generatedEssay && (
              <div className="bg-green-50 border p-4 rounded mb-6">
                <h2 className="text-xl font-semibold mb-2">📄 AI 작성 결과</h2>
                <p className="whitespace-pre-wrap text-gray-800 leading-relaxed">
                  {generatedEssay}
                </p>
              </div>
            )}

            {history.length > 0 && (
              <div className="mt-6">
                <h3 className="text-lg font-semibold mb-2">📜 생성 이력</h3>
                <ul className="text-sm space-y-2">
                  {history.map((item) => (
                    <li key={item.id} className="bg-white p-2 rounded border">
                      <strong>{item.genre.label}</strong> - {item.topic.topic}
                      <br />
                      <span className="text-gray-500 text-xs">
                        {item.generatedAt}
                      </span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("generator-root")).render(
        <TopicGenreGenerator />
      );
    </script>
  </body>
</html>
