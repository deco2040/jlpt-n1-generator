<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JLPT N1 ÎèÖÌï¥ Î¨∏Ï†ú ÏÉùÏÑ±Í∏∞ (Í≥†Í∏â)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="theme-color" content="#3B82F6" />
    <meta
      name="description"
      content="Claude AIÍ∞Ä Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÏÉàÎ°úÏö¥ JLPT N1 ÎèÖÌï¥ Î¨∏Ï†úÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§ - 25Í∞ÄÏßÄ ÏÑ∏Î∂Ä Ïú†Ìòï ÏßÄÏõê"
    />

    <!-- ÌååÎπÑÏΩò ÏÑ§Ï†ï -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìñ</text></svg>"
    />

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          sans-serif;
      }
      .subtype-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 500;
        background-color: #f3e8ff;
        color: #7c3aed;
        border-radius: 9999px;
      }
      .difficulty-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: 9999px;
      }
      .difficulty-basic {
        background-color: #d1fae5;
        color: #065f46;
      }
      .difficulty-advanced {
        background-color: #fee2e2;
        color: #b91c1c;
      }
      .weight-indicator {
        background: linear-gradient(
          90deg,
          #3b82f6 var(--weight-percent),
          #e5e7eb var(--weight-percent)
        );
        border-radius: 4px;
        height: 4px;
        margin-top: 2px;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;
      const { createRoot } = ReactDOM;

      // Î°úÎî© ÏïÑÏù¥ÏΩò Ïª¥Ìè¨ÎÑåÌä∏
      const LoaderIcon = () => (
        <svg
          className="animate-spin -ml-1 mr-3 h-5 w-5 text-white"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            className="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            strokeWidth="4"
          ></circle>
          <path
            className="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
      );

      const ReadingGenerator = () => {
        // ‚úÖ JSONÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú Î°úÎî©Ìï† ÏôÑÏ†ÑÌïú Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞
        const [lengthDefinitions, setLengthDefinitions] = useState(null);
        const [lengthOptions, setLengthOptions] = useState({});
        const [questionConfig, setQuestionConfig] = useState({});
        const [randomWeights, setRandomWeights] = useState({});
        const [isConfigLoaded, setIsConfigLoaded] = useState(false);

        const [currentProblem, setCurrentProblem] = useState(null);
        const [customPrompt, setCustomPrompt] = useState("");
        const [generationType, setGenerationType] = useState("auto");
        const [selectedLength, setSelectedLength] = useState("medium");
        const [showAnswer, setShowAnswer] = useState(false);
        const [score, setScore] = useState({ correct: 0, total: 0 });
        const [isGenerating, setIsGenerating] = useState(false);
        const [generationHistory, setGenerationHistory] = useState([]);
        const [apiStatus, setApiStatus] = useState("ÌôïÏù∏ Ï§ë...");
        const [debugInfo, setDebugInfo] = useState([]);

        // ‚úÖ ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ Ìï®Ïàò
        const addDebugLog = (message, data = null) => {
          const logEntry = {
            timestamp: new Date().toLocaleTimeString(),
            message,
            data: data
              ? {
                  ...data,
                  questionCount:
                    data.questionCount || data.metadata?.questionCount,
                  actualQuestions:
                    data.questions?.length || (data.question ? 1 : 0),
                  lengthType: data.length,
                  subtype: data.subtype,
                }
              : null,
          };
          setDebugInfo((prev) => [logEntry, ...prev.slice(0, 6)]);
          console.log(`[DEBUG] ${message}`, logEntry.data);
        };

        // ‚úÖ ÏôÑÏ†ÑÌïú JSON Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ìï®Ïàò
        const loadLengthDefinitions = async () => {
          try {
            addDebugLog("length-definitions.json Î°úÎî© ÏãúÏûë");

            const response = await fetch(
              "/api/get-config?type=length-definitions"
            );
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            const data = await response.json();
            addDebugLog("JSON Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ", {
              version: data.metadata?.version,
              totalTypes: data.metadata?.total_types,
              categories: Object.keys(data.length_categories || {}),
              hasQuestionConfig: !!data.question_count_config,
              hasRandomWeights: !!data.random_selection_weights,
            });

            // ‚úÖ ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
            setLengthDefinitions(data);
            setQuestionConfig(data.question_count_config || {});
            setRandomWeights(data.random_selection_weights || {});

            // ‚úÖ ÌîÑÎ°†Ìä∏ÏóîÎìúÏö© ÏòµÏÖò Î≥ÄÌôò
            const transformedOptions = {};

            if (data.length_categories) {
              Object.entries(data.length_categories).forEach(
                ([key, category]) => {
                  const baseInfo = category.base_info;
                  const questionRange =
                    data.question_count_config?.ranges?.[key];
                  const subtypeCount = Object.keys(
                    category.subtypes || {}
                  ).length;

                  transformedOptions[key] = {
                    label: baseInfo.label,
                    description: baseInfo.description,
                    characterRange: baseInfo.character_range,
                    questionCountDisplay: baseInfo.question_count_display,
                    possibleCounts: questionRange?.possible_counts || [1],
                    weights: questionRange?.weights || null,
                    defaultCount: questionRange?.default || 1,
                    icon: baseInfo.icon,
                    subtypes: subtypeCount,
                    estimatedTime: baseInfo.estimated_time_minutes || 5,
                    characteristics: baseInfo.base_characteristics,
                    // ‚úÖ ÏÑ∏Î∂Ä Ïú†Ìòï Ï†ïÎ≥¥ Ìè¨Ìï®
                    subtypeDetails: category.subtypes || {},
                  };
                }
              );
            }

            setLengthOptions(transformedOptions);
            setIsConfigLoaded(true);

            addDebugLog("Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò ÏôÑÎ£å", {
              optionKeys: Object.keys(transformedOptions),
              totalSubtypes: Object.values(transformedOptions).reduce(
                (sum, opt) => sum + opt.subtypes,
                0
              ),
            });
          } catch (error) {
            console.error("length-definitions.json Î°úÎìú Ïã§Ìå®:", error);
            addDebugLog("JSON Î°úÎìú Ïã§Ìå®, Ìè¥Î∞± ÏÇ¨Ïö©", error.message);

            // ‚úÖ ÏµúÏÜåÌïúÏùò Ìè¥Î∞± Îç∞Ïù¥ÌÑ∞
            const fallbackOptions = {
              short: {
                label: "Îã®Î¨∏ (Áü≠Êñá)",
                description: "ÏßßÏùÄ ÏßÄÎ¨∏ÏúºÎ°ú ÌïµÏã¨ ÎÇ¥Ïö© ÌååÏïÖ",
                characterRange: "200~400Ïûê",
                questionCountDisplay: "1Î¨∏Ï†ú",
                possibleCounts: [1],
                weights: null,
                icon: "üìÑ",
                subtypes: 5,
                estimatedTime: 3,
                subtypeDetails: {},
              },
              medium: {
                label: "Ï§ëÎ¨∏ (‰∏≠Êñá)",
                description: "Ï†ÅÎãπÌïú Í∏∏Ïù¥Ïùò ÎÖºÏÑ§Î¨∏Ïù¥ÎÇò ÏÑ§Î™ÖÎ¨∏",
                characterRange: "450~700Ïûê",
                questionCountDisplay: "1~2Î¨∏Ï†ú",
                possibleCounts: [1, 2],
                weights: [40, 60],
                icon: "üìÉ",
                subtypes: 5,
                estimatedTime: 7,
                subtypeDetails: {},
              },
              long: {
                label: "Ïû•Î¨∏ (Èï∑Êñá)",
                description: "Í∏¥ ÏßÄÎ¨∏ÏúºÎ°ú Ïã¨ÌôîÎêú ÎèÖÌï¥Î†• ÌèâÍ∞Ä",
                characterRange: "800~1200Ïûê",
                questionCountDisplay: "3~5Î¨∏Ï†ú",
                possibleCounts: [3, 4, 5],
                weights: [30, 50, 20],
                icon: "üìë",
                subtypes: 5,
                estimatedTime: 15,
                subtypeDetails: {},
              },
            };

            setLengthOptions(fallbackOptions);
            setQuestionConfig({
              ranges: {
                short: { possible_counts: [1], default: 1 },
                medium: {
                  possible_counts: [1, 2],
                  weights: [40, 60],
                  default: 2,
                },
                long: {
                  possible_counts: [3, 4, 5],
                  weights: [30, 50, 20],
                  default: 4,
                },
              },
            });
            setIsConfigLoaded(true);
          }
        };

        // API ÏÉÅÌÉú ÌôïÏù∏
        const checkAPIStatus = async () => {
          try {
            await new Promise((resolve) => setTimeout(resolve, 1000));
            setApiStatus("üü¢ ÎèÖÌï¥ ÏÉùÏÑ± API Ï§ÄÎπÑÎê® (25Í∞ÄÏßÄ ÏÑ∏Î∂Ä Ïú†Ìòï ÏßÄÏõê)");
          } catch (error) {
            setApiStatus("üî¥ API Ïó∞Í≤∞ Ïã§Ìå®");
          }
        };

        // ‚úÖ Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú JSON Î°úÎî©
        useEffect(() => {
          loadLengthDefinitions();
          checkAPIStatus();
        }, []);

        // ‚úÖ Î¨∏Ï†ú Ïàò Î≤îÏúÑ ÌëúÏãú Ìï®Ïàò
        const getQuestionCountRange = (lengthType) => {
          const option = lengthOptions[lengthType];
          if (!option || !option.possibleCounts) return "1Î¨∏Ï†ú";

          const counts = option.possibleCounts;
          if (counts.length === 1) {
            return `${counts[0]}Î¨∏Ï†ú`;
          } else {
            return `${Math.min(...counts)}~${Math.max(...counts)}Î¨∏Ï†ú`;
          }
        };

        // ‚úÖ Ïã§Ï†ú ÏÉùÏÑ±Îêú Î¨∏Ï†ú Ïàò ÌëúÏãú Ìï®Ïàò
        const getActualQuestionCount = (problem) => {
          if (
            problem.questionCount &&
            typeof problem.questionCount === "number"
          ) {
            return `${problem.questionCount}Í∞ú`;
          }

          if (
            problem.metadata?.questionCount &&
            typeof problem.metadata.questionCount === "number"
          ) {
            return `${problem.metadata.questionCount}Í∞ú`;
          }

          if (problem.questions && Array.isArray(problem.questions)) {
            return `${problem.questions.length}Í∞ú`;
          }

          if (problem.question && !problem.questions) {
            return "1Í∞ú";
          }

          return "ÎØ∏ÌôïÏù∏";
        };

        // ‚úÖ ÏòàÏÉÅ ÏãúÍ∞Ñ Í≥ÑÏÇ∞ Ìï®Ïàò
        const getEstimatedTime = (problem) => {
          const baseTime = lengthOptions[problem.length]?.estimatedTime || 5;

          let actualQuestionCount = 1;
          if (problem.questionCount) {
            actualQuestionCount = problem.questionCount;
          } else if (problem.metadata?.questionCount) {
            actualQuestionCount = problem.metadata.questionCount;
          } else if (problem.questions) {
            actualQuestionCount = problem.questions.length;
          }

          if (problem.length === "short") return baseTime;

          const adjustedTime = baseTime + (actualQuestionCount - 1) * 2;
          return Math.max(adjustedTime, 3);
        };

        // ‚úÖ ÌôïÎ•† Î∂ÑÌè¨ ÌëúÏãú Ìï®Ïàò
        const getQuestionCountProbability = (lengthType) => {
          const option = lengthOptions[lengthType];
          if (!option || !option.possibleCounts || !option.weights) {
            return null;
          }

          return option.possibleCounts.map((count, index) => ({
            count,
            probability: option.weights[index],
            isDefault: count === option.defaultCount,
          }));
        };

        // ‚úÖ ÏÑ∏Î∂Ä Ïú†Ìòï Ï†ïÎ≥¥ ÌëúÏãú Ìï®Ïàò
        const getSubtypeInfo = (lengthType) => {
          const option = lengthOptions[lengthType];
          if (!option || !option.subtypeDetails) return [];

          return Object.entries(option.subtypeDetails).map(
            ([key, details]) => ({
              key,
              label: details.label,
              description: details.description,
              characterRange: details.character_range,
              weight: randomWeights[lengthType]?.[key] || 0,
            })
          );
        };

        // ‚úÖ Î°úÎî© Ï§ëÏù¥Î©¥ Î°úÎî© ÌëúÏãú
        if (!isConfigLoaded) {
          return (
            <div className="max-w-4xl mx-auto p-6 bg-white min-h-screen">
              <div className="text-center">
                <h1 className="text-3xl font-bold text-gray-800 mb-4">
                  üìñ JLPT N1 ÎèÖÌï¥ Î¨∏Ï†ú ÏÉùÏÑ±Í∏∞ (Í≥†Í∏â)
                </h1>
                <div className="flex items-center justify-center gap-3">
                  <LoaderIcon />
                  <span className="text-gray-600">
                    ÏÑ∏Î∂Ä ÏÑ§Ï†ï ÌååÏùºÏùÑ Î°úÎî©ÌïòÍ≥† ÏûàÏäµÎãàÎã§...
                  </span>
                </div>
                <p className="text-sm text-gray-500 mt-2">
                  25Í∞ÄÏßÄ ÏÑ∏Î∂Ä Ïú†Ìòï Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                </p>
              </div>
            </div>
          );
        }

        // Î¨∏Ï†ú ÏÉùÏÑ± Ìï®Ïàò
        const generateProblem = async () => {
          addDebugLog("ÎèÖÌï¥ Î¨∏Ï†ú ÏÉùÏÑ± ÏãúÏûë", {
            type: generationType,
            length: selectedLength,
            hasCustomPrompt: !!customPrompt.trim(),
          });
          setIsGenerating(true);
          setCurrentProblem(null);
          setShowAnswer(false);

          try {
            const requestData =
              generationType === "custom" && customPrompt.trim()
                ? {
                    type: "custom",
                    prompt: customPrompt.trim(),
                    length: selectedLength,
                  }
                : {
                    type: "generate",
                    length: selectedLength,
                  };

            addDebugLog("API ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞", requestData);

            const response = await fetch("/api/generate-reading", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(requestData),
            });

            addDebugLog("API ÏùëÎãµ ÏÉÅÌÉú", {
              status: response.status,
              statusText: response.statusText,
              ok: response.ok,
            });

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            const result = await response.json();
            if (!result.success) {
              throw new Error(result.error || "API ÏùëÎãµ Ïã§Ìå®");
            }
            const data = result.data;
            addDebugLog("API ÏùëÎãµ Îç∞Ïù¥ÌÑ∞", data);

            if (data.success) {
              const problem = {
                ...data.problem,
                id: Date.now(),
                displayedAt: new Date().toLocaleString("ko-KR"),
              };

              setCurrentProblem(problem);
              setGenerationHistory((prev) => [problem, ...prev.slice(0, 9)]);

              addDebugLog("Î¨∏Ï†ú ÏÉùÏÑ± ÏÑ±Í≥µ", {
                problemId: problem.id,
                subtype: problem.subtype,
                trapDifficulty: problem.trapDifficulty,
                questionCount:
                  problem.questionCount || problem.metadata?.questionCount,
                actualQuestions:
                  problem.questions?.length || (problem.question ? 1 : 0),
                length: problem.length,
                isConsistent:
                  (problem.questionCount || problem.metadata?.questionCount) ===
                  (problem.questions?.length || (problem.question ? 1 : 0)),
              });

              if (generationType === "custom") {
                setCustomPrompt("");
              }
            } else {
              const problem = {
                ...data.problem,
                id: Date.now(),
                displayedAt: new Date().toLocaleString("ko-KR"),
                isBackup: true,
              };

              setCurrentProblem(problem);
              addDebugLog("Î∞±ÏóÖ Î¨∏Ï†ú ÏÇ¨Ïö©", data.message);
            }
          } catch (error) {
            addDebugLog("ÏÉùÏÑ± Ïã§Ìå®", error.message);

            const fallbackProblem = {
              type: "reading",
              length: selectedLength,
              subtype: "fallback",
              topic: "Í∏∞Ïà†Í≥º ÏÇ¨Ìöå Î≥ÄÌôî",
              passage:
                "Áèæ‰ª£Á§æ‰ºö„Å´„Åä„ÅÑ„Å¶„ÄÅÊäÄË°ì„ÅÆÈÄ≤Ê≠©„ÅØÊàë„ÄÖ„ÅÆÁîüÊ¥ª„ÇíÂ§ß„Åç„ÅèÂ§â„Åà„Å¶„ÅÑ„Çã„ÄÇÁâπ„Å´„Çπ„Éû„Éº„Éà„Éï„Ç©„É≥„ÅÆÊôÆÂèä„Å´„Çà„Çä„ÄÅ„ÅÑ„Å§„Åß„ÇÇ„Å©„Åì„Åß„ÇÇÊÉÖÂ†±„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Å£„Åü„ÄÇ„Åó„Åã„Åó„ÄÅ„Åì„ÅÆ‰æøÂà©„Åï„ÅÆ‰∏ÄÊñπ„Åß„ÄÅ‰∫∫„ÄÖ„ÅÆÈõÜ‰∏≠Âäõ‰Ωé‰∏ã„ÇÑÂØæÈù¢„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÊ∏õÂ∞ë„Å®„ÅÑ„Å£„ÅüÂïèÈ°å„ÇÇÊåáÊëò„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ",
              question:
                "„Åì„ÅÆÊñáÁ´†„ÅßËø∞„Åπ„Çâ„Çå„Å¶„ÅÑ„ÇãÊäÄË°ì„ÅÆÈÄ≤Ê≠©„Å´„Å§„ÅÑ„Å¶ÊúÄ„ÇÇÈÅ©Âàá„Å™„ÇÇ„ÅÆ„ÅØ„Å©„Çå„Åß„Åô„Åã„ÄÇ",
              choices: [
                "‰æøÂà©„Åï„Å®ÂïèÈ°å„ÅÆ‰∏°Èù¢„Åå„ÅÇ„Çã„Åì„Å®„ÇíÁ§∫„Åó„Å¶„ÅÑ„Çã",
                "ÂÆåÂÖ®„Å´ËÇØÂÆöÁöÑ„Å™ÂΩ±Èüø„Åó„Åã„Å™„ÅÑ„Å®Ëø∞„Åπ„Å¶„ÅÑ„Çã",
                "ÊäÄË°ì„ÅÆÈÄ≤Ê≠©„ÅåÈÅÖ„ÅÑ„Åì„Å®„ÇíÊâπÂà§„Åó„Å¶„ÅÑ„Çã",
                "„Çπ„Éû„Éº„Éà„Éï„Ç©„É≥‰ª•Â§ñ„ÅÆÊäÄË°ì„Å´„Å§„ÅÑ„Å¶Ë´ñ„Åò„Å¶„ÅÑ„Çã",
              ],
              correct: 0,
              explanation:
                "Î¨∏Ïû•ÏóêÏÑúÎäî Í∏∞Ïà† ÏßÑÎ≥¥Ïùò Ìé∏Î¶¨Ìï®Í≥º Ìï®Íªò ÏßëÏ§ëÎ†• Ï†ÄÌïò, ÎåÄÎ©¥ ÏÜåÌÜµ Í∞êÏÜå Îì±Ïùò Î¨∏Ï†úÏ†êÎèÑ Ìï®Íªò Ïñ∏Í∏âÌïòÍ≥† ÏûàÏäµÎãàÎã§.",
              source: "ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Î∞±ÏóÖ",
              id: Date.now(),
              displayedAt: new Date().toLocaleString("ko-KR"),
              isError: true,
            };

            setCurrentProblem(fallbackProblem);
            alert(`Î¨∏Ï†ú ÏÉùÏÑ± Ïã§Ìå®: ${error.message}\nÎ∞±ÏóÖ Î¨∏Ï†úÎ•º ÌëúÏãúÌï©ÎãàÎã§.`);
          }

          setIsGenerating(false);
        };

        // ÎãµÏïà Ï≤òÎ¶¨ Ìï®Ïàò
        const handleAnswer = (questionIndex, selectedIndex) => {
          if (!currentProblem) return;

          let isCorrect = false;

          if (typeof currentProblem.correct === "number") {
            isCorrect = selectedIndex === currentProblem.correct;
          } else if (
            currentProblem.questions &&
            currentProblem.questions[questionIndex]
          ) {
            isCorrect =
              selectedIndex === currentProblem.questions[questionIndex].correct;
          }

          if (isCorrect) {
            setScore((prev) => ({
              correct: prev.correct + 1,
              total: prev.total + 1,
            }));
          } else {
            setScore((prev) => ({ ...prev, total: prev.total + 1 }));
          }
          setShowAnswer(true);
        };

        // ÎãµÏïà Ïä§ÌÉÄÏùºÎßÅ Ìï®Ïàò
        const getButtonStyle = (questionIndex, choiceIndex) => {
          if (!showAnswer) {
            return "bg-white hover:bg-blue-50 border border-gray-300 text-gray-700";
          }

          let correctIndex;
          if (typeof currentProblem.correct === "number") {
            correctIndex = currentProblem.correct;
          } else if (
            currentProblem.questions &&
            currentProblem.questions[questionIndex]
          ) {
            correctIndex = currentProblem.questions[questionIndex].correct;
          }

          if (choiceIndex === correctIndex) {
            return "bg-green-100 border-green-500 text-green-800";
          } else {
            return "bg-red-100 border-red-300 text-red-700";
          }
        };

        // ÏïàÏ†ÑÌïú Î¨∏ÏûêÏó¥ Î†åÎçîÎßÅ Ìï®Ïàò
        const safeRenderText = (value) => {
          if (typeof value === "string") {
            return value;
          } else if (typeof value === "object" && value !== null) {
            if (value.topic) return value.topic;
            if (value.category) return value.category;
            if (value.label) return value.label;
            return JSON.stringify(value);
          }
          return String(value);
        };

        // ÏÑ∏Î∂Ä Ïú†Ìòï Ï†ïÎ≥¥ Î†åÎçîÎßÅ
        const renderSubtypeInfo = (problem) => {
          if (!problem.subtypeInfo && !problem.subtype) return null;

          const subtypeLabel =
            problem.subtypeInfo?.definition?.label ||
            problem.subtype ||
            "ÎØ∏Î∂ÑÎ•ò";
          const subtypeDescription =
            problem.subtypeInfo?.definition?.description ||
            "ÏÑ∏Î∂Ä Ïú†Ìòï Ï†ïÎ≥¥ ÏóÜÏùå";

          return (
            <div className="mb-4 p-3 bg-purple-50 rounded border-l-4 border-purple-400">
              <div className="flex items-center gap-2 mb-2">
                <span className="subtype-badge">{subtypeLabel}</span>
                {problem.trapDifficulty && (
                  <span
                    className={`difficulty-badge ${
                      problem.trapDifficulty === "Í≥†ÎÇúÏù¥ÎèÑ"
                        ? "difficulty-advanced"
                        : "difficulty-basic"
                    }`}
                  >
                    {problem.trapDifficulty}
                  </span>
                )}
              </div>
              <p className="text-sm text-purple-800">
                <strong>Ïú†Ìòï ÌäπÏßï:</strong> {subtypeDescription}
              </p>
              {problem.subtypeInfo?.definition?.question_focus && (
                <p className="text-sm text-purple-800 mt-1">
                  <strong>ÏßàÎ¨∏ Ï¥àÏ†ê:</strong>{" "}
                  {problem.subtypeInfo.definition.question_focus}
                </p>
              )}
            </div>
          );
        };

        // Î¨∏Ï†ú Î†åÎçîÎßÅ Ìï®Ïàò
        const renderProblem = () => {
          if (!currentProblem) return null;

          // Îã®Ïùº Î¨∏Ï†úÏù∏ Í≤ΩÏö∞
          if (currentProblem.question && currentProblem.choices) {
            return (
              <div>
                <div className="mb-6">
                  <p className="text-lg mb-4">
                    <span className="font-bold">{currentProblem.question}</span>
                  </p>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                  {currentProblem.choices?.map((choice, index) => (
                    <button
                      key={index}
                      onClick={() => handleAnswer(0, index)}
                      disabled={showAnswer}
                      className={`p-4 rounded-lg text-left transition-colors ${getButtonStyle(
                        0,
                        index
                      )}`}
                    >
                      <span className="font-semibold mr-2">{index + 1}.</span>
                      {choice}
                    </button>
                  ))}
                </div>

                {showAnswer && (
                  <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h4 className="font-semibold text-blue-800 mb-2">
                      Ï†ïÎãµ Î∞è Ìï¥ÏÑ§
                    </h4>
                    <p className="text-blue-700">
                      <span className="font-bold">Ï†ïÎãµ:</span>{" "}
                      {currentProblem.correct + 1}Î≤à -{" "}
                      {currentProblem.choices[currentProblem.correct]}
                    </p>
                    <p className="text-blue-700 mt-2">
                      <span className="font-bold">Ìï¥ÏÑ§:</span>{" "}
                      {currentProblem.explanation}
                    </p>
                  </div>
                )}
              </div>
            );
          }

          // Îã§Ï§ë Î¨∏Ï†úÏù∏ Í≤ΩÏö∞
          if (
            currentProblem.questions &&
            Array.isArray(currentProblem.questions)
          ) {
            return (
              <div>
                {currentProblem.questions.map((questionObj, qIndex) => (
                  <div key={qIndex} className="mb-8">
                    <div className="mb-6">
                      <h4 className="text-lg font-semibold mb-2">
                        Î¨∏Ï†ú {qIndex + 1}
                      </h4>
                      <p className="text-lg mb-4">
                        <span className="font-bold">
                          {questionObj.question}
                        </span>
                      </p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                      {questionObj.choices?.map((choice, cIndex) => (
                        <button
                          key={`${qIndex}-${cIndex}`}
                          onClick={() => handleAnswer(qIndex, cIndex)}
                          disabled={showAnswer}
                          className={`p-4 rounded-lg text-left transition-colors ${getButtonStyle(
                            qIndex,
                            cIndex
                          )}`}
                        >
                          <span className="font-semibold mr-2">
                            {cIndex + 1}.
                          </span>
                          {choice}
                        </button>
                      ))}
                    </div>

                    {showAnswer && (
                      <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                        <h4 className="font-semibold text-blue-800 mb-2">
                          Î¨∏Ï†ú {qIndex + 1} Ï†ïÎãµ Î∞è Ìï¥ÏÑ§
                        </h4>
                        <p className="text-blue-700">
                          <span className="font-bold">Ï†ïÎãµ:</span>{" "}
                          {questionObj.correct + 1}Î≤à -{" "}
                          {questionObj.choices[questionObj.correct]}
                        </p>
                        <p className="text-blue-700 mt-2">
                          <span className="font-bold">Ìï¥ÏÑ§:</span>{" "}
                          {questionObj.explanation}
                        </p>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            );
          }

          return <div>Î¨∏Ï†ú ÌòïÏãùÏùÑ Ïù∏ÏãùÌï† Ïàò ÏóÜÏäµÎãàÎã§.</div>;
        };

        // ‚úÖ ÏÑ∏Î∂Ä Ïú†Ìòï Ï†ïÎ≥¥ ÌëúÏãú Ïª¥Ìè¨ÎÑåÌä∏
        const SubtypeSelector = ({ lengthType, isSelected }) => {
          const subtypes = getSubtypeInfo(lengthType);

          if (!isSelected || subtypes.length === 0) return null;

          return (
            <div className="mt-3 p-3 bg-indigo-50 rounded border">
              <h4 className="text-sm font-semibold text-indigo-800 mb-2">
                ÏÑ∏Î∂Ä Ïú†Ìòï ({subtypes.length}Í∞ÄÏßÄ)
              </h4>
              <div className="grid grid-cols-1 gap-2">
                {subtypes.map((subtype) => (
                  <div
                    key={subtype.key}
                    className="flex items-center justify-between text-xs"
                  >
                    <div className="flex-1">
                      <span className="font-medium text-indigo-700">
                        {subtype.label}
                      </span>
                      <span className="text-gray-600 ml-2">
                        {subtype.characterRange}
                      </span>
                    </div>
                    <div className="flex items-center gap-1">
                      <span className="text-indigo-600">{subtype.weight}%</span>
                      <div
                        className="weight-indicator w-8"
                        style={{ "--weight-percent": `${subtype.weight}%` }}
                      ></div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          );
        };

        return (
          <div className="max-w-6xl mx-auto p-6 bg-white min-h-screen">
            {/* Ìó§Îçî */}
            <div className="text-center mb-8">
              <h1 className="text-3xl font-bold text-gray-800 mb-2">
                üìñ JLPT N1 ÎèÖÌï¥ Î¨∏Ï†ú ÏÉùÏÑ±Í∏∞ (Í≥†Í∏â)
              </h1>
              <p className="text-gray-600">
                Claude AIÍ∞Ä Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÏÉàÎ°úÏö¥ N1 ÎèÖÌï¥ Î¨∏Ï†úÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§!
              </p>
              <p className="text-sm text-purple-600 mt-1">
                ‚ú®{" "}
                {Object.values(lengthOptions).reduce(
                  (sum, opt) => sum + opt.subtypes,
                  0
                )}
                Í∞ÄÏßÄ ÏÑ∏Î∂Ä Ïú†Ìòï ÏßÄÏõê ‚Ä¢ Í∞ÄÏ§ëÏπò Í∏∞Î∞ò ÎûúÎç§ ÏÑ†ÌÉù ‚Ä¢ N1 Ìï®Ï†ï ÏöîÏÜå Ìè¨Ìï®
              </p>
              {lengthDefinitions?.metadata && (
                <p className="text-xs text-gray-500 mt-1">
                  Î≤ÑÏ†Ñ {lengthDefinitions.metadata.version} | ÏóÖÎç∞Ïù¥Ìä∏:{" "}
                  {lengthDefinitions.metadata.last_updated}
                </p>
              )}
            </div>

            {/* ÏÉÅÌÉú ÌëúÏãú */}
            <div className="grid md:grid-cols-4 gap-4 mb-6">
              <div className="bg-blue-50 p-4 rounded-lg text-center">
                <div className="text-lg font-semibold text-blue-800">
                  Ï†ïÎãµÎ•†:{" "}
                  {score.total > 0
                    ? Math.round((score.correct / score.total) * 100)
                    : 0}
                  %
                </div>
                <div className="text-sm text-blue-600">
                  ({score.correct}/{score.total})
                </div>
              </div>
              <div className="bg-green-50 p-4 rounded-lg text-center">
                <div className="text-lg font-semibold text-green-800">
                  ÏÉùÏÑ±Îêú Î¨∏Ï†ú: {generationHistory.length}Í∞ú
                </div>
              </div>
              <div className="bg-purple-50 p-4 rounded-lg text-center">
                <div className="text-sm font-semibold text-purple-800">
                  {apiStatus}
                </div>
              </div>
              <div className="bg-orange-50 p-4 rounded-lg text-center">
                <div className="text-sm font-semibold text-orange-800">
                  Ï¥ù{" "}
                  {Object.values(lengthOptions).reduce(
                    (sum, opt) => sum + opt.subtypes,
                    0
                  )}
                  Í∞ÄÏßÄ ÏÑ∏Î∂Ä Ïú†Ìòï
                </div>
              </div>
            </div>

            {/* Í∏∏Ïù¥ ÏÑ†ÌÉù */}
            <div className="mb-6">
              <h3 className="text-lg font-semibold mb-3">Í∏Ä Í∏∏Ïù¥ ÏÑ†ÌÉù</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                {Object.entries(lengthOptions).map(([key, option]) => (
                  <div key={key} className="relative">
                    <button
                      onClick={() => setSelectedLength(key)}
                      className={`w-full p-4 rounded-lg border-2 transition-colors text-left ${
                        selectedLength === key
                          ? "border-blue-500 bg-blue-50 text-blue-800"
                          : "border-gray-200 bg-white text-gray-700 hover:bg-gray-50"
                      }`}
                    >
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center">
                          <span className="text-xl mr-2">{option.icon}</span>
                          <span className="font-semibold">{option.label}</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <span className="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">
                            {option.subtypes}Í∞ÄÏßÄ
                          </span>
                          {option.weights && (
                            <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">
                              Í∞ÄÏ§ëÏπò
                            </span>
                          )}
                        </div>
                      </div>
                      <div className="text-sm text-gray-600">
                        <div className="mb-1">{option.description}</div>
                        <div className="grid grid-cols-2 gap-2 text-xs">
                          <div>
                            <span className="font-medium">Í∏∏Ïù¥:</span>{" "}
                            {option.characterRange}
                          </div>
                          <div>
                            <span className="font-medium">Î¨∏Ï†ú:</span>{" "}
                            {getQuestionCountRange(key)}
                          </div>
                          <div>
                            <span className="font-medium">ÏãúÍ∞Ñ:</span>{" "}
                            {option.estimatedTime}Î∂Ñ
                          </div>
                          <div>
                            <span className="font-medium">ÌäπÏÑ±:</span>{" "}
                            {option.characteristics?.substring(0, 10)}...
                          </div>
                        </div>
                        {/* ÌôïÎ•† Î∂ÑÌè¨ ÌëúÏãú */}
                        {selectedLength === key &&
                          getQuestionCountProbability(key) && (
                            <div className="mt-2 p-2 bg-blue-50 rounded text-xs">
                              <div className="font-medium text-blue-800 mb-1">
                                Î¨∏Ï†ú Ïàò ÌôïÎ•†:
                              </div>
                              <div className="space-y-1">
                                {getQuestionCountProbability(key).map(
                                  ({ count, probability, isDefault }) => (
                                    <div
                                      key={count}
                                      className="flex justify-between items-center"
                                    >
                                      <span
                                        className={isDefault ? "font-bold" : ""}
                                      >
                                        {count}Î¨∏Ï†ú{isDefault ? " (Í∏∞Î≥∏)" : ""}:
                                      </span>
                                      <div className="flex items-center gap-1">
                                        <span className="font-medium">
                                          {probability}%
                                        </span>
                                        <div
                                          className="weight-indicator w-6"
                                          style={{
                                            "--weight-percent": `${probability}%`,
                                          }}
                                        ></div>
                                      </div>
                                    </div>
                                  )
                                )}
                              </div>
                            </div>
                          )}
                      </div>
                    </button>

                    {/* ÏÑ∏Î∂Ä Ïú†Ìòï Ï†ïÎ≥¥ */}
                    <SubtypeSelector
                      lengthType={key}
                      isSelected={selectedLength === key}
                    />
                  </div>
                ))}
              </div>

              {/* Î¨∏Ï†ú Ïàò ÏïàÎÇ¥ */}
              <div className="mb-4 p-3 bg-yellow-50 rounded border-l-4 border-yellow-400">
                <p className="text-sm text-yellow-800">
                  <strong>‚ÑπÔ∏è Î¨∏Ï†ú Ïàò ÏïàÎÇ¥:</strong>
                  ÏÑ†ÌÉùÌïú Í∏∏Ïù¥ Ïú†ÌòïÏóêÏÑú {getQuestionCountRange(selectedLength)}Í∞Ä
                  Í∞ÄÏ§ëÏπò Í∏∞Î∞òÏúºÎ°ú ÎûúÎç§ÌïòÍ≤å ÏÉùÏÑ±Îê©ÎãàÎã§.
                  {getQuestionCountProbability(selectedLength) && (
                    <span> ÏúÑÏùò ÌôïÎ•† Î∂ÑÌè¨Î•º Ï∞∏Í≥†ÌïòÏÑ∏Ïöî.</span>
                  )}
                </p>
              </div>
            </div>

            {/* ÏÉùÏÑ± Î∞©Ïãù ÏÑ†ÌÉù */}
            <div className="mb-6">
              <h3 className="text-lg font-semibold mb-3">Î¨∏Ï†ú ÏÉùÏÑ± Î∞©Ïãù</h3>
              <div className="flex flex-wrap gap-2 mb-4">
                <button
                  onClick={() => setGenerationType("auto")}
                  className={`px-4 py-2 rounded-lg transition-colors ${
                    generationType === "auto"
                      ? "bg-blue-500 text-white"
                      : "bg-gray-100 text-gray-700 hover:bg-gray-200"
                  }`}
                >
                  üé≤ ÏûêÎèô ÏÉùÏÑ± (Ï∂îÏ≤ú)
                </button>
                <button
                  onClick={() => setGenerationType("custom")}
                  className={`px-4 py-2 rounded-lg transition-colors ${
                    generationType === "custom"
                      ? "bg-blue-500 text-white"
                      : "bg-gray-100 text-gray-700 hover:bg-gray-200"
                  }`}
                >
                  ‚úèÔ∏è Ïª§Ïä§ÌÖÄ ÌîÑÎ°¨ÌîÑÌä∏
                </button>
              </div>

              {/* Ïª§Ïä§ÌÖÄ ÌîÑÎ°¨ÌîÑÌä∏ ÏûÖÎ†• */}
              {generationType === "custom" && (
                <div className="mt-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Ïª§Ïä§ÌÖÄ ÌîÑÎ°¨ÌîÑÌä∏ ÏûÖÎ†•
                  </label>
                  <textarea
                    value={customPrompt}
                    onChange={(e) => setCustomPrompt(e.target.value)}
                    placeholder="ÏõêÌïòÎäî Ï£ºÏ†úÎÇò ÏöîÍµ¨ÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                    className="w-full h-32 p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    Ïòà: "ÌôòÍ≤Ω Î¨∏Ï†úÏóê ÎåÄÌïú ÎÖºÏÑ§Î¨∏ ÌòïÌÉúÏùò ÎèÖÌï¥ Î¨∏Ï†úÎ•º
                    ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî"
                  </p>
                  <p className="text-xs text-blue-600 mt-1">
                    ÏÑ†ÌÉùÌïú Í∏Ä Í∏∏Ïù¥ ({lengthOptions[selectedLength]?.label})ÏôÄ
                    ÎûúÎç§ ÏÑ∏Î∂Ä Ïú†ÌòïÏù¥ ÏûêÎèôÏúºÎ°ú Ï†ÅÏö©Îê©ÎãàÎã§.
                  </p>
                </div>
              )}
            </div>

            {/* Î¨∏Ï†ú ÏÉùÏÑ± Î≤ÑÌäº */}
            <div className="text-center mb-8">
              <button
                onClick={generateProblem}
                disabled={
                  isGenerating ||
                  (generationType === "custom" && !customPrompt.trim())
                }
                className="bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white px-8 py-3 rounded-lg text-lg font-semibold transition-colors flex items-center gap-2 mx-auto"
              >
                {isGenerating ? (
                  <>
                    <LoaderIcon />
                    AIÍ∞Ä ÎèÖÌï¥ Î¨∏Ï†ú ÏÉùÏÑ± Ï§ë...
                  </>
                ) : (
                  <>
                    üöÄ {generationType === "auto" ? "ÏûêÎèô ÏÉùÏÑ±" : "Ïª§Ïä§ÌÖÄ ÏÉùÏÑ±"}
                    <span className="text-sm font-normal">
                      ({lengthOptions[selectedLength]?.label} -{" "}
                      {getQuestionCountRange(selectedLength)})
                    </span>
                  </>
                )}
              </button>
              {isGenerating && (
                <p className="text-sm text-gray-600 mt-2">
                  {lengthOptions[selectedLength]?.label} ÌòïÌÉúÏùò N1 ÎèÖÌï¥ Î¨∏Ï†úÎ•º
                  ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§. Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî...
                </p>
              )}
            </div>

            {/* Î¨∏Ï†ú ÌëúÏãú */}
            {currentProblem && (
              <div className="bg-gray-50 p-6 rounded-lg mb-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-xl font-semibold">
                    ÎèÖÌï¥ Î¨∏Ï†ú (
                    {lengthOptions[currentProblem.length || selectedLength]
                      ?.label || "ÌëúÏ§Ä"}
                    )
                  </h3>
                  <div className="text-sm text-gray-500 text-right">
                    <div className="flex items-center gap-2">
                      <span>{currentProblem.source || "AI ÏÉùÏÑ±"}</span>
                      {/* Ïã§Ï†ú Î¨∏Ï†ú Ïàò Î∞∞ÏßÄ */}
                      <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">
                        {getActualQuestionCount(currentProblem)}
                      </span>
                    </div>
                    <div>{currentProblem.displayedAt}</div>
                    {currentProblem.isBackup && (
                      <div className="text-yellow-600">‚ö†Ô∏è Î∞±ÏóÖ Î¨∏Ï†ú</div>
                    )}
                    {currentProblem.isError && (
                      <div className="text-red-600">üî¥ Ïò§Î•ò ÎåÄÏ≤¥</div>
                    )}
                  </div>
                </div>

                {/* ÏÑ∏Î∂Ä Ïú†Ìòï Ï†ïÎ≥¥ ÌëúÏãú */}
                {renderSubtypeInfo(currentProblem)}

                {/* Î©îÌÉÄ Ï†ïÎ≥¥ ÌëúÏãú */}
                {(currentProblem.topic ||
                  currentProblem.questionCount ||
                  currentProblem.lengthInfo) && (
                  <div className="mb-4 p-3 bg-blue-50 rounded border-l-4 border-blue-400">
                    {currentProblem.topic && (
                      <p className="text-sm text-blue-800">
                        <strong>Ï£ºÏ†ú:</strong>{" "}
                        {safeRenderText(currentProblem.topic)}
                      </p>
                    )}
                    {currentProblem.genre && (
                      <p className="text-sm text-blue-800">
                        <strong>Ïû•Î•¥:</strong>{" "}
                        {safeRenderText(currentProblem.genre)}
                      </p>
                    )}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
                      <div>
                        <span className="font-medium text-blue-800">
                          Í∏Ä Í∏∏Ïù¥:
                        </span>{" "}
                        <span className="text-blue-800">
                          {currentProblem.lengthInfo?.character_range ||
                            currentProblem.lengthInfo?.characterRange ||
                            lengthOptions[currentProblem.length]
                              ?.characterRange}
                        </span>
                      </div>
                      <div>
                        <span className="font-medium text-blue-800">
                          Î¨∏Ï†ú Ïàò:
                        </span>{" "}
                        <span className="text-blue-800">
                          {getActualQuestionCount(currentProblem)}
                        </span>
                      </div>
                      <div>
                        <span className="font-medium text-blue-800">
                          ÏòàÏÉÅ ÏãúÍ∞Ñ:
                        </span>{" "}
                        <span className="text-blue-800">
                          {getEstimatedTime(currentProblem)}Î∂Ñ
                        </span>
                      </div>
                    </div>
                    {/* ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ */}
                    {currentProblem.metadata?.questionCount && (
                      <p className="text-xs text-blue-600 mt-2">
                        Î∞±ÏóîÎìú ÏÉùÏÑ± Î¨∏Ï†ú Ïàò:{" "}
                        {currentProblem.metadata.questionCount}Í∞ú
                        {currentProblem.questionCount &&
                          currentProblem.questionCount !==
                            currentProblem.metadata.questionCount && (
                            <span className="text-orange-600">
                              {" "}
                              (Î∂àÏùºÏπò Í∞êÏßÄ)
                            </span>
                          )}
                      </p>
                    )}
                  </div>
                )}

                {/* ÏßÄÎ¨∏ - ÎπÑÍµêÌòïÏù∏ Í≤ΩÏö∞ Îëê Í∞ú ÏßÄÎ¨∏ ÌëúÏãú */}
                {currentProblem.length === "comparative" &&
                currentProblem.passage1 &&
                currentProblem.passage2 ? (
                  <div className="mb-6 space-y-4">
                    <div className="p-4 bg-white rounded border">
                      <h4 className="font-semibold mb-2 text-gray-700">
                        ÏßÄÎ¨∏ 1
                      </h4>
                      <p className="text-gray-800 leading-relaxed text-lg">
                        {currentProblem.passage1}
                      </p>
                    </div>
                    <div className="p-4 bg-white rounded border">
                      <h4 className="font-semibold mb-2 text-gray-700">
                        ÏßÄÎ¨∏ 2
                      </h4>
                      <p className="text-gray-800 leading-relaxed text-lg">
                        {currentProblem.passage2}
                      </p>
                    </div>
                  </div>
                ) : (
                  <div className="mb-6 p-4 bg-white rounded border">
                    <p className="text-gray-800 leading-relaxed text-lg">
                      {currentProblem.passage}
                    </p>
                  </div>
                )}

                {/* Î¨∏Ï†ú Î†åÎçîÎßÅ */}
                {renderProblem()}
              </div>
            )}

            {/* ÏµúÍ∑º ÏÉùÏÑ± Ïù¥Î†• */}
            {generationHistory.length > 0 && (
              <div className="mt-8">
                <h3 className="text-lg font-semibold mb-3">
                  ÏµúÍ∑º ÏÉùÏÑ±Îêú Î¨∏Ï†úÎì§
                </h3>
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                  {generationHistory.slice(0, 6).map((problem) => (
                    <div
                      key={problem.id}
                      className="bg-gray-100 p-3 rounded text-sm"
                    >
                      <div className="flex justify-between items-center mb-1">
                        <div className="flex items-center gap-2">
                          <span className="font-semibold">
                            ÎèÖÌï¥ (
                            {lengthOptions[problem.length]?.label || "ÌëúÏ§Ä"})
                          </span>
                          {problem.subtypeInfo?.definition?.label && (
                            <span className="subtype-badge text-xs">
                              {problem.subtypeInfo.definition.label}
                            </span>
                          )}
                          {/* Î¨∏Ï†ú Ïàò Î∞∞ÏßÄ */}
                          <span className="bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded text-xs font-medium">
                            {getActualQuestionCount(problem)}
                          </span>
                        </div>
                        <span className="text-gray-500 text-xs">
                          {problem.source}
                        </span>
                      </div>
                      <p className="text-gray-700 truncate">
                        {safeRenderText(problem.topic) ||
                          problem.passage?.substring(0, 30)}
                        ...
                      </p>
                      <div className="flex justify-between items-center mt-1">
                        <p className="text-xs text-gray-500">
                          {problem.displayedAt}
                        </p>
                        <div className="flex items-center gap-1">
                          {problem.trapDifficulty && (
                            <span
                              className={`text-xs px-1 py-0.5 rounded ${
                                problem.trapDifficulty === "Í≥†ÎÇúÏù¥ÎèÑ"
                                  ? "bg-red-100 text-red-600"
                                  : "bg-green-100 text-green-600"
                              }`}
                            >
                              {problem.trapDifficulty}
                            </span>
                          )}
                          {/* ÏòàÏÉÅ ÏãúÍ∞Ñ ÌëúÏãú */}
                          <span className="text-xs bg-gray-200 text-gray-600 px-1 py-0.5 rounded">
                            {getEstimatedTime(problem)}Î∂Ñ
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ (Í∞úÎ∞ú Î™®ÎìúÏùº ÎïåÎßå) */}
            {debugInfo.length > 0 && (
              <div className="mt-8 bg-yellow-50 border-l-4 border-yellow-400 p-4">
                <h3 className="text-lg font-semibold mb-2 flex items-center">
                  üõ† ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥
                  <button
                    onClick={() => setDebugInfo([])}
                    className="ml-2 text-xs bg-yellow-200 hover:bg-yellow-300 px-2 py-1 rounded"
                  >
                    ÏßÄÏö∞Í∏∞
                  </button>
                </h3>
                <div className="max-h-60 overflow-y-auto text-sm">
                  {debugInfo.map((log, index) => (
                    <div key={index} className="mb-2 font-mono">
                      <span className="text-gray-500">[{log.timestamp}]</span>{" "}
                      {log.message}
                      {log.data && (
                        <pre className="mt-1 text-xs bg-gray-100 p-1 rounded overflow-x-auto max-h-20">
                          {JSON.stringify(log.data, null, 2)}
                        </pre>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Ìë∏ÌÑ∞ */}
            <div className="mt-12 text-center text-gray-500 text-sm">
              <p className="font-semibold">
                JLPT N1 ÎåÄÎπÑÏö© ÎèÖÌï¥ Î¨∏Ï†ú ÏÉùÏÑ±Í∏∞ (Í≥†Í∏â Î≤ÑÏ†Ñ)
              </p>
              <p className="mt-1">
                {Object.values(lengthOptions).reduce(
                  (sum, opt) => sum + opt.subtypes,
                  0
                )}
                Í∞ÄÏßÄ ÏÑ∏Î∂Ä Ïú†Ìòï ‚Ä¢ JSON Í∏∞Î∞ò ÎèôÏ†Å ÏÑ§Ï†ï ‚Ä¢ Í∞ÄÏ§ëÏπò ÎûúÎç§ ÏÑ†ÌÉù ‚Ä¢ N1
                Ìï®Ï†ï ÏöîÏÜå Ìè¨Ìï®
              </p>
              <div className="flex justify-center items-center gap-4 mt-2 text-xs">
                <span>üìä ÎèôÏ†Å ÏÑ§Ï†ï Î°úÎî©</span>
                <span>üéØ Ï†ïÌôïÌïú Î¨∏Ï†ú Ïàò Î≥¥Ïû•</span>
                <span>‚ö° ÏµúÏ†ÅÌôîÎêú ÏÑ±Îä•</span>
                <span>üîÑ Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî</span>
                <span>üß© ÏÑ∏Î∂Ä Ïú†Ìòï Î∂ÑÏÑù</span>
              </div>
              {lengthDefinitions?.metadata && (
                <p className="mt-1 text-xs">
                  ÏÑ§Ï†ï Î≤ÑÏ†Ñ: {lengthDefinitions.metadata.version} | ÏµúÏ¢Ö
                  ÏóÖÎç∞Ïù¥Ìä∏: {lengthDefinitions.metadata.last_updated}
                </p>
              )}
              <p className="mt-1">
                Ïã§Ï†ú ÏãúÌóòÍ≥ºÎäî Îã§Î•º Ïàò ÏûàÏúºÎãà Ï∞∏Í≥†Ïö©ÏúºÎ°úÎßå ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.
              </p>
            </div>
          </div>
        );
      };

      // React 18 Î∞©ÏãùÏúºÎ°ú Ïï± Î†åÎçîÎßÅ
      const root = createRoot(document.getElementById("root"));
      root.render(<ReadingGenerator />);
    </script>
  </body>
</html>
