<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JLPT N1 독해 문제 생성기</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="theme-color" content="#3B82F6" />
  </head>
  <body class="bg-slate-50 text-slate-800">
    <div id="root" class="min-h-screen"></div>

    <script type="text/babel">
      const { useState } = React;
      const { createRoot } = ReactDOM;

      // ----- 유틸 -----
      const LENGTH_OPTIONS = [
        { key: "short", label: "단문 (200~400자)" },
        { key: "medium", label: "중문 (450~700자)" },
        { key: "long", label: "장문 (800~1,000자+)" },
        { key: "comparative", label: "종합 이해 (2지문)" },
        { key: "practical", label: "정보 검색 (600~1,200자)" },
      ];

      // 서버에서 topic/genre를 요약본으로 내려주므로 안전 렌더
      const safeRenderText = (value) => {
        if (value == null) return "";
        if (typeof value === "string") return value;
        if (typeof value === "number" || typeof value === "boolean")
          return String(value);
        if (typeof value === "object") {
          if (value.topic) return value.topic; // { category, topic }
          if (value.label) return value.label; // { label } from genre
          if (value.category) return value.category;
          return JSON.stringify(value);
        }
        return "";
      };

      const CodeBlock = ({ title, data }) => (
        <div class="mt-3">
          <div class="text-sm font-semibold text-slate-600 mb-1">{title}</div>
          <pre class="bg-slate-900 text-slate-100 rounded-lg p-3 overflow-auto text-sm">
            {JSON.stringify(data, null, 2)}
          </pre>
        </div>
      );

      const Field = ({ label, children }) => (
        <div class="mb-3">
          <div class="text-xs font-medium text-slate-500 mb-1">{label}</div>
          <div class="text-slate-900">{children}</div>
        </div>
      );

      function ReadingGenerator() {
        const [apiUrl, setApiUrl] = useState("/api/generate-reading");
        const [length, setLength] = useState("practical"); // 요청 예시에 맞춰 기본값 practical
        const [customMode, setCustomMode] = useState(false);
        const [customPrompt, setCustomPrompt] = useState("");
        const [loading, setLoading] = useState(false);
        const [result, setResult] = useState(null);
        const [error, setError] = useState(null);

        const callApi = async () => {
          setLoading(true);
          setError(null);
          setResult(null);
          try {
            const payload = customMode
              ? { type: "custom", prompt: customPrompt, length }
              : { type: "generate", length };

            const resp = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const data = await resp.json();
            if (!resp.ok) throw new Error(data?.message || "API 오류");

            // 백엔드가 success=false여도 백업문제 내려주니 그대로 표시
            setResult(data);
          } catch (e) {
            setError(e.message || "요청 실패");
          } finally {
            setLoading(false);
          }
        };

        const clearAll = () => {
          setResult(null);
          setError(null);
          setCustomPrompt("");
        };

        const problem = result?.problem;

        return (
          <div class="max-w-5xl mx-auto p-4 sm:p-6">
            <header class="mb-6">
              <h1 class="text-2xl font-bold">JLPT N1 독해 문제 생성기</h1>
              <p class="text-slate-500 text-sm mt-1">
                장르/주제는 프롬프트 생성엔 풀데이터 사용, 화면에는 요약 메타만
                표시.
              </p>
            </header>

            {/* 설정 카드 */}
            <section class="bg-white rounded-2xl shadow p-4 sm:p-6 mb-6">
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-slate-700">
                    API URL
                  </label>
                  <input
                    class="w-full mt-1 px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
                    value={apiUrl}
                    onChange={(e) => setApiUrl(e.target.value)}
                    placeholder="/api/generate-reading"
                  />
                </div>

                <div>
                  <label class="text-sm font-medium text-slate-700">
                    글 길이
                  </label>
                  <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-2">
                    {LENGTH_OPTIONS.map((opt) => (
                      <button
                        key={opt.key}
                        onClick={() => setLength(opt.key)}
                        class={`px-3 py-2 rounded-lg border text-sm ${
                          length === opt.key
                            ? "bg-blue-600 text-white border-blue-600"
                            : "bg-white hover:bg-slate-50"
                        }`}
                        type="button"
                      >
                        {opt.label}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              <div class="mt-4 flex items-center gap-3">
                <label class="inline-flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    class="w-4 h-4"
                    checked={customMode}
                    onChange={(e) => setCustomMode(e.target.checked)}
                  />
                  <span class="text-sm font-medium">커스텀 프롬프트 사용</span>
                </label>
              </div>

              {customMode && (
                <div class="mt-3">
                  <textarea
                    class="w-full min-h-[120px] px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
                    value={customPrompt}
                    onChange={(e) => setCustomPrompt(e.target.value)}
                    placeholder="직접 작성한 지시문(프롬프트)을 입력하세요. 서버가 길이 규격/언어 규칙을 자동으로 보강합니다."
                  />
                </div>
              )}

              <div class="mt-4 flex flex-wrap gap-2">
                <button
                  type="button"
                  onClick={callApi}
                  disabled={loading || (customMode && !customPrompt.trim())}
                  class={`px-4 py-2 rounded-lg text-white ${
                    loading ? "bg-blue-300" : "bg-blue-600 hover:bg-blue-700"
                  }`}
                >
                  {loading
                    ? "생성 중..."
                    : customMode
                    ? "커스텀 생성"
                    : "자동 생성"}
                </button>
                <button
                  type="button"
                  onClick={clearAll}
                  class="px-4 py-2 rounded-lg border hover:bg-slate-50"
                >
                  초기화
                </button>
              </div>
            </section>

            {/* 결과/오류 */}
            {error && (
              <div class="bg-red-50 border border-red-200 text-red-700 rounded-xl p-4 mb-6">
                <div class="font-semibold">에러</div>
                <div class="text-sm mt-1">{error}</div>
              </div>
            )}

            {result && (
              <section class="bg-white rounded-2xl shadow p-4 sm:p-6">
                <h2 class="text-xl font-bold mb-4">생성 결과</h2>

                {/* 메타 요약 */}
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <Field label="메시지">{result.message || "-"}</Field>
                    <Field label="생성 유형">
                      {result.metadata?.promptType || "-"}
                    </Field>
                    <Field label="길이">{result.metadata?.length || "-"}</Field>
                    <Field label="생성 시각">
                      {result.problem?.generatedAt || "-"}
                    </Field>
                  </div>
                  <div>
                    <Field label="주제">{safeRenderText(problem?.topic)}</Field>
                    <Field label="주제 카테고리">
                      {safeRenderText(problem?.topic?.category)}
                    </Field>
                    <Field label="장르">{safeRenderText(problem?.genre)}</Field>
                    <Field label="자동 번역 적용">
                      {String(result.metadata?.autoTranslated ?? false)}
                    </Field>
                  </div>
                </div>

                {/* 본문/문항 프리뷰 */}
                <div class="mt-6 grid lg:grid-cols-2 gap-6">
                  <div>
                    <div class="text-sm font-semibold text-slate-600 mb-1">
                      본문 / Passage
                    </div>
                    <div class="bg-slate-100 rounded-lg p-3 whitespace-pre-wrap min-h-[120px]">
                      {problem?.passage || problem?.passage1 || "(본문 없음)"}
                    </div>
                    {problem?.passage2 && (
                      <div class="mt-3">
                        <div class="text-sm font-semibold text-slate-600 mb-1">
                          본문2 / Passage2
                        </div>
                        <div class="bg-slate-100 rounded-lg p-3 whitespace-pre-wrap min-h-[120px]">
                          {problem?.passage2}
                        </div>
                      </div>
                    )}
                  </div>

                  <div>
                    <div class="text-sm font-semibold text-slate-600 mb-2">
                      문항 / Questions
                    </div>
                    {/* 단문 포맷(단일 question/choices) 대응 */}
                    {problem?.question && (
                      <div class="mb-4 border rounded-lg p-3">
                        <div class="font-medium mb-1">{problem.question}</div>
                        <ol class="list-decimal ml-5">
                          {(problem.choices || []).map((c, i) => (
                            <li key={i} class="mt-1">
                              {c}
                            </li>
                          ))}
                        </ol>
                        <div class="mt-2 text-sm text-emerald-700">
                          정답:{" "}
                          {typeof problem.correct === "number"
                            ? problem.correct + 1
                            : "-"}
                        </div>
                        {problem.explanation && (
                          <div class="mt-2 text-sm text-slate-700 whitespace-pre-wrap">
                            해설: {problem.explanation}
                          </div>
                        )}
                      </div>
                    )}

                    {/* 배열 questions 포맷 대응 */}
                    {Array.isArray(problem?.questions) &&
                      problem.questions.length > 0 && (
                        <div class="space-y-3">
                          {problem.questions.map((q, idx) => (
                            <div key={idx} class="border rounded-lg p-3">
                              <div class="font-medium mb-1">{q.question}</div>
                              <ol class="list-decimal ml-5">
                                {(q.choices || []).map((c, i) => (
                                  <li key={i} class="mt-1">
                                    {c}
                                  </li>
                                ))}
                              </ol>
                              <div class="mt-2 text-sm text-emerald-700">
                                정답:{" "}
                                {typeof q.correct === "number"
                                  ? q.correct + 1
                                  : "-"}
                              </div>
                              {q.explanation && (
                                <div class="mt-2 text-sm text-slate-700 whitespace-pre-wrap">
                                  해설: {q.explanation}
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      )}
                  </div>
                </div>

                {/* 원본 JSON */}
                <CodeBlock title="서버 응답 전체(JSON)" data={result} />
              </section>
            )}

            <footer class="py-10 text-center text-xs text-slate-400">
              © JLPT N1 Generator
            </footer>
          </div>
        );
      }

      const root = createRoot(document.getElementById("root"));
      root.render(<ReadingGenerator />);
    </script>
  </body>
</html>
